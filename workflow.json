{
  "name": "Stage 3 \u2013 Auto Post to Facebook & LinkedIn (FIXED)",
  "nodes": [
    {
      "parameters": {},
      "id": "node-s3-manual",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        240,
        600
      ]
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 15
            }
          ]
        }
      },
      "id": "node-s3-schedule",
      "name": "Every 15 Minutes",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        240,
        480
      ]
    },
    {
      "parameters": {
        "operation": "search",
        "base": {
          "__rl": true,
          "value": "={{ $env.AIRTABLE_BASE_ID }}",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "={{ $env.AT_TABLE_SCRIPT_LIB }}",
          "mode": "id"
        },
        "options": {
          "filterByFormula": "{Status} = 'Approved'",
          "maxRecords": 20,
          "sort": [
            {
              "field": "Created_Date",
              "direction": "asc"
            }
          ]
        }
      },
      "id": "node-s3-read",
      "name": "Read Approved Scripts",
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        460,
        560
      ],
      "credentials": {
        "airtableTokenApi": {
          "id": "rWrYEtYQAEpY7zli",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\n\nif (!items || items.length === 0) {\n  console.log('No approved scripts found.');\n  return [{ json: { _skip: true } }];\n}\n\nconst approved = items.filter(i => (i.json?.Status || '').trim() === 'Approved');\n\nif (approved.length === 0) {\n  console.log('No approved scripts to post.');\n  return [{ json: { _skip: true } }];\n}\n\n// Group by Source_Content_ID \u2014 pick first group only per run\nlet targetSourceId = null;\nfor (const i of approved) {\n  const sid = Array.isArray(i.json?.Source_Content_ID)\n    ? i.json.Source_Content_ID[0]\n    : i.json?.Source_Content_ID;\n  if (sid) { targetSourceId = sid; break; }\n}\n\nif (!targetSourceId) targetSourceId = approved[0].json.id;\n\nconsole.log('Processing group for Source_Content_ID: ' + targetSourceId);\n\nconst group = approved.filter(i => {\n  const sid = Array.isArray(i.json?.Source_Content_ID)\n    ? i.json.Source_Content_ID[0]\n    : i.json?.Source_Content_ID;\n  return sid === targetSourceId || (!sid && i.json.id === targetSourceId);\n});\n\nconsole.log('Scripts in this group: ' + group.length);\n\nreturn group.map(item => {\n  // Detect platform from Target_Platforms field\n  let platformRaw = item.json['Target_Platforms '] || item.json['Target_Platforms'] || '';\n  if (Array.isArray(platformRaw)) platformRaw = platformRaw.join(',');\n  platformRaw = platformRaw.toLowerCase();\n\n  let platform = 'linkedin'; // default\n  if (platformRaw.includes('face') || platformRaw.includes('fb')) platform = 'facebook';\n  if (platformRaw.includes('linkedin')) platform = 'linkedin';\n\n  // Also fallback to Script_Title\n  const title = (item.json.Script_Title || '').toLowerCase();\n  if (!platformRaw) {\n    if (title.includes('facebook') || title.includes('fb')) platform = 'facebook';\n    else platform = 'linkedin';\n  }\n\n  console.log('Script: ' + item.json.Script_Title + ' \u2192 Platform: ' + platform);\n\n  return {\n    json: {\n      ...item.json,\n      _target_platform: platform,\n      _airtable_id: item.json.id\n    }\n  };\n});"
      },
      "id": "node-s3-filter",
      "name": "Filter & Group by Source",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        680,
        560
      ]
    },
    {
      "parameters": {
        "mode": "rules",
        "rules": {
          "rules": [
            {
              "conditions": {
                "conditions": [
                  {
                    "leftValue": "={{ $json._target_platform }}",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "rightValue": "facebook"
                  }
                ]
              }
            },
            {
              "conditions": {
                "conditions": [
                  {
                    "leftValue": "={{ $json._target_platform }}",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "rightValue": "linkedin"
                  }
                ]
              }
            }
          ]
        }
      },
      "id": "node-s3-switch",
      "name": "Switch: Facebook or LinkedIn",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [
        900,
        560
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v20.0/{{ $env.FACEBOOK_PAGE_ID }}/feed",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "message",
              "value": "={{ [$json.Hook, $json.Main_Content, $json['CTA '] || $json.CTA].filter(v => v && String(v).trim()).join('\\n\\n') }}"
            },
            {
              "name": "access_token",
              "value": "={{ $env.FACEBOOK_PAGE_ACCESS_TOKEN }}"
            }
          ]
        },
        "options": {
          "timeout": 45000
        }
      },
      "id": "node-s3-facebook",
      "name": "Post to Facebook",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1120,
        440
      ],
      "onError": "continueRegular"
    },
    {
      "parameters": {
        "text": "={{ [$json.Hook, $json.Main_Content, $json['CTA '] || $json.CTA].filter(v => v && String(v).trim()).join('\\n\\n') }}",
        "additionalFields": {}
      },
      "id": "node-s3-linkedin",
      "name": "Post to LinkedIn",
      "type": "n8n-nodes-base.linkedIn",
      "typeVersion": 1,
      "position": [
        1120,
        700
      ],
      "credentials": {
        "linkedInOAuth2Api": {
          "id": "EjVjU4yvzE7uSE2U",
          "name": "LinkedIn account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "base": {
          "__rl": true,
          "value": "={{ $env.AIRTABLE_BASE_ID }}",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "={{ $env.AT_TABLE_SCRIPT_LIB }}",
          "mode": "id"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Status": "Posted",
            "Posted_Date": "={{ $now.format('yyyy-MM-dd HH:mm:ss') }}",
            "id": "={{ $json._airtable_id }}"
          },
          "matchingColumns": [
            "id"
          ]
        },
        "options": {
          "typecast": true
        }
      },
      "id": "node-s3-mark-fb",
      "name": "Mark Posted (Facebook)",
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        1340,
        440
      ],
      "credentials": {
        "airtableTokenApi": {
          "id": "rWrYEtYQAEpY7zli",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "base": {
          "__rl": true,
          "value": "={{ $env.AIRTABLE_BASE_ID }}",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "={{ $env.AT_TABLE_SCRIPT_LIB }}",
          "mode": "id"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Status": "Posted",
            "Posted_Date": "={{ $now.format('yyyy-MM-dd HH:mm:ss') }}",
            "id": "={{ $json._airtable_id }}"
          },
          "matchingColumns": [
            "id"
          ]
        },
        "options": {
          "typecast": true
        }
      },
      "id": "node-s3-mark-li",
      "name": "Mark Posted (LinkedIn)",
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        1340,
        700
      ],
      "credentials": {
        "airtableTokenApi": {
          "id": "rWrYEtYQAEpY7zli",
          "name": "Airtable Personal Access Token account"
        }
      }
    }
  ],
  "connections": {
    "Manual Trigger": {
      "main": [
        [
          {
            "node": "Read Approved Scripts",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Every 15 Minutes": {
      "main": [
        [
          {
            "node": "Read Approved Scripts",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Read Approved Scripts": {
      "main": [
        [
          {
            "node": "Filter & Group by Source",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter & Group by Source": {
      "main": [
        [
          {
            "node": "Switch: Facebook or LinkedIn",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch: Facebook or LinkedIn": {
      "main": [
        [
          {
            "node": "Post to Facebook",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Post to LinkedIn",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Post to Facebook": {
      "main": [
        [
          {
            "node": "Mark Posted (Facebook)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Post to LinkedIn": {
      "main": [
        [
          {
            "node": "Mark Posted (LinkedIn)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "id": "stage3-fixed-2026",
  "tags": []
}