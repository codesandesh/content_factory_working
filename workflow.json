{
  "name": "STANDALONE 3 â€” FFmpeg + Submagic Final Assembly",
  "nodes": [
    {
      "parameters": {
        "jsCode": "// Filter Stage 2 - Emit ONE item per post so Gemini generates exactly ONE script per post\n// Capture the Airtable Record ID from the item object\nconst allItems = $input.all();\nconst output = [];\n\nfor (const item of allItems) {\n  // Debug: Check what structure we're getting\n  const fields = item.json.fields || item.json || {};\n  const status = fields.Status || item.json?.Status || item.json?.status || fields.status || '';\n\n  if (status.toString().trim() === 'Generate Script') {\n    // Try multiple ways to get the record ID\n    const airtable_record_id = item.id || item.json?.id || item.json?.fields?.id || '';\n    const post_id = fields.Post_ID || item.json?.Post_ID || item.json?.fields?.Post_ID || '';\n    \n    const content = fields.Content || item.json?.Content || item.json?.content || '';\n    const transcript = fields.Transcript || item.json?.Transcript || item.json?.transcript || '';\n    const shares = fields.Shares_Awards || item.json?.Shares_Awards || fields.Engagement_Rate || item.json?.engagement_rate || 0;\n    const viral_score = fields.Viral_Score || item.json?.Viral_Score || 0;\n    const hook = fields.Narrative_Hook || item.json?.Narrative_Hook || item.json?.narrative_hook || '';\n    const theme = fields.Visual_Theme || item.json?.Visual_Theme || item.json?.visual_theme || '';\n    const story = fields.Core_Story || item.json?.Core_Story || item.json?.core_story || '';\n    const platform = fields.Platform || item.json?.Platform || item.json?.platform || '';\n\n    const postBlock = `===\\nPost_ID: ${post_id}\\nContent: ${content}\\nTranscript: ${transcript}\\nShares_Awards: ${shares}\\nViral_Score: ${viral_score}\\nNarrative_Hook: ${hook}\\nVisual_Theme: ${theme}\\nCore_Story: ${story}\\nPlatform: ${platform}`;\n\n    output.push({\n      json: {\n        all_viral_content: postBlock,\n        source_record_id: airtable_record_id,\n        source_post_id: post_id,\n        _debug_item_id: item.id,\n        _debug_json_id: item.json?.id\n      }\n    });\n  }\n}\n\nreturn output;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        176,
        -64
      ],
      "id": "6e952e2a-741f-4d21-8b4c-6cac129c76a8",
      "name": "Filter: Status = Generate Script"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=# VIRAL CONTENT ADVERTISING ENGINE\n\n## RAW VIRAL DATA INPUTS\n{{ $json.all_viral_content }}\n\n---\n\n## WHO YOU ARE\nYou are a viral content strategist and direct-response marketer for B2B SaaS.\nYou do NOT write generic ads.\nYou FIRST analyze what type of viral content you are dealing with.\nThen you write a talking head script that matches THAT content type's energy, format, and emotional trigger.\nThe content type determines the script style. Never force a character story onto breaking news. Never force a news format onto a meme. Match the energy.\n\n---\n\n## THE BRANDS (Choose One Per Script)\n1. **ScaleBuild**: Target: Founders/Agencies. Pitch: Build audiences, scale systems, stop grinding manually.\n2. **ScaleLova AI**: Target: Marketers/Ops. Pitch: Automate everything, AI workflows, eliminate 40 hours of manual work.\n\n---\n\n## STEP 1 â€” CLASSIFY THE VIRAL CONTENT TYPE\n\nBefore writing anything, read the post data and assign it ONE of the following content types:\n\n| Type | Description | Script Style to Use |\n|---|---|---|\n| **NEWS** | Breaking news, political event, world event, crisis | Hot Take â€” give a sharp, controversial business opinion on the news |\n| **AI / TECH INNOVATION** | New tool, model launch, tech breakthrough | Authority Play â€” position yourself as the expert who already knew this was coming |\n| **CHARACTER / EMOTION** | A person's story, struggle, triumph, embarrassing moment | Mirror Story â€” make the viewer see themselves in that character's situation |\n| **MEME / HUMOR** | Funny format, absurd situation, relatable joke | Comedian Hook â€” use the joke's punchline structure to land your pitch |\n| **WAR / CONFLICT / TENSION** | Geopolitical conflict, social conflict, confrontation | Stakes Raiser â€” use the conflict's urgency to make business inaction feel dangerous |\n| **SCIENCE / NATURE / DISCOVERY** | Space, biology, animal behavior, environment | Curiosity Hook â€” open with the awe or shock, then pivot to business insight |\n| **SPORTS / COMPETITION** | Athletic achievement, failure, rivalry | Underdog or Champion Frame â€” tie winning/losing to business performance |\n| **FINANCE / ECONOMY** | Markets, recession, inflation, wealth news | Fear or Greed Trigger â€” tap into financial anxiety or ambition |\n| **LIFESTYLE / CULTURE** | Trends, fashion, celebrity, social behavior | Identity Play â€” make the viewer feel left behind or ahead of the curve |\n\n---\n\n## STEP 2 â€” APPLY THE MATCHING SCRIPT STYLE\n\nOnce you have classified the content type, write the script using the rules for THAT type:\n\n---\n\n### IF TYPE = NEWS\n- Open with your HOT TAKE on what this news means for business owners RIGHT NOW.\n- Do not report the news. React to it like a founder who sees the angle no one else does.\n- Example Hook: \\\"Everyone's panicking about [news topic]. Smart operators are doing the opposite.\\\"\n\n---\n\n### IF TYPE = AI / TECH INNOVATION\n- Open by making the viewer feel like they are already behind.\n- Position yourself as someone who saw this coming and already adapted.\n- Example Hook: \\\"While everyone is just hearing about [innovation], I've been using it to automate [specific task] for 3 months.\\\"\n\n---\n\n### IF TYPE = CHARACTER / EMOTION\n- Drop the viewer directly into the character's emotional peak.\n- Make them feel they ARE that person right now.\n- Use the character's conflict as a mirror for a specific business pain.\n- Example Hook: \\\"You know exactly what that feels like. Doing everything right and still watching it fall apart.\\\"\n\n---\n\n### IF TYPE = MEME / HUMOR\n- Use the meme's joke structure (setup -> punchline) but redirect the punchline at a business pain.\n- Keep it light and fast in the hook, then pivot hard to reality in the agitation.\n- Example Hook: \\\"This is literally every founder trusting a VA to handle their entire pipeline manually.\\\"\n\n---\n\n### IF TYPE = WAR / CONFLICT / TENSION\n- Use the urgency and stakes of the conflict to make business complacency feel like surrender.\n- Frame manual work or slow systems as the enemy attacking them daily.\n- Example Hook: \\\"Every day you run your business manually, you are losing ground to someone who already automated it.\\\"\n\n---\n\n### IF TYPE = SCIENCE / NATURE / DISCOVERY\n- Open with the wow moment â€” the fact or discovery that stops the scroll.\n- Immediately pivot: \\\"The same principle is happening in your business right now.\\\"\n- Example Hook: \\\"It took [discovery fact] to happen naturally. Your competition isn't waiting for nature. They're using AI.\\\"\n\n---\n\n### IF TYPE = SPORTS / COMPETITION\n- Frame the viewer as either the underdog who can win or the champion about to be overtaken.\n- Tie athletic performance directly to business systems and speed.\n- Example Hook: \\\"The difference between first and second place is not talent. It's the system behind the athlete.\\\"\n\n---\n\n### IF TYPE = FINANCE / ECONOMY\n- Tap into fear (losing money, falling behind) OR greed (the opportunity hiding in the chaos).\n- Make inaction feel like a financial decision they are already making poorly.\n- Example Hook: \\\"While the market is doing that, your competitors just cut costs by automating their entire ops team.\\\"\n\n---\n\n### IF TYPE = LIFESTYLE / CULTURE\n- Make the viewer feel they are either ahead of a trend or dangerously behind it.\n- Use social identity and status to drive urgency.\n- Example Hook: \\\"The founders still doing this manually are the new people who refused to get a smartphone in 2010.\\\"\n\n---\n\n## STEP 3 â€” UNIVERSAL SCRIPT STRUCTURE (Apply to ALL types)\n\nEvery script follows this structure regardless of content type:\n\n**HOOK (0-4s)**: Stop the scroll. Use the classified style's opening technique. Present tense. Visceral. No \\\"Did you see...\\\" ever.\n\n**AGITATION (4-12s)**: Name the SPECIFIC manual business pain. Not generic. Real tasks. Real consequences. Make them feel it.\n\n**PITCH + CTA (12-20s)**: Position ScaleBuild or ScaleLova AI as the solution that matches the emotional resolution of the content type. One hard CTA.\n\n---\n\n## STRICT RULES\n- 60-70 words max total across all three scenes combined.\n- Never mention the original video, creator, or platform by name.\n- Never say \\\"Did you see...\\\" / \\\"This video...\\\" / \\\"Going viral...\\\"\n- No hashtags in the spoken script.\n- Always write in first or second person only â€” \\\"you\\\" or \\\"I\\\".\n- Name a specific real pain point â€” never vague phrases like \\\"scale your business.\\\"\n- The classified content type's energy must carry through all three scenes.\n\n---\n\n## OUTPUT FORMAT\nReturn ONLY valid JSON. No markdown. No explanation. No extra text.\n\n{\n  \\\"scripts\\\": [\n    {\n      \\\"script_title\\\": \\\"[Brand] - [Content Type] - [Core Hook Angle]\\\",\n      \\\"content_type_detected\\\": \\\"[NEWS / AI-TECH / CHARACTER-EMOTION / MEME / WAR-CONFLICT / SCIENCE / SPORTS / FINANCE / LIFESTYLE]\\\",\n      \\\"script_style_applied\\\": \\\"[Hot Take / Authority Play / Mirror Story / Comedian Hook / Stakes Raiser / Curiosity Hook / Underdog Frame / Fear Trigger / Identity Play]\\\",\n      \\\"core_pain_targeted\\\": \\\"[The specific business task or pain extracted from the viral content context]\\\",\n      \\\"variation\\\": 1,\n      \\\"scenes\\\": [\n        {\n          \\\"type\\\": \\\"hook\\\",\n          \\\"text\\\": \\\"[Scroll-stopping open using the classified style â€” present tense â€” visceral]\\\",\n          \\\"visual\\\": \\\"[Talking head: expression matching the content type energy]\\\",\n          \\\"duration\\\": 4,\n          \\\"avatar_visible\\\": true\n        },\n        {\n          \\\"type\\\": \\\"main\\\",\n          \\\"text\\\": \\\"[Specific business pain agitation â€” real tasks â€” real consequences â€” twist the knife]\\\",\n          \\\"visual\\\": \\\"[B-roll or screen recording matching the pain being described]\\\",\n          \\\"duration\\\": 12,\n          \\\"avatar_visible\\\": false\n        },\n        {\n          \\\"type\\\": \\\"cta\\\",\n          \\\"text\\\": \\\"[Brand as the resolution â€” hard single CTA]\\\",\n          \\\"visual\\\": \\\"[Talking head pointing down with urgency]\\\",\n          \\\"duration\\\": 4,\n          \\\"avatar_visible\\\": true\n        }\n      ],\n      \\\"tone\\\": \\\"[Empathetic-Aggressive / Hot-Take / Comedic-Pivot / Urgent-Authority / Awe-to-Action]\\\",\n      \\\"target_platforms\\\": [\\\"Instagram\\\", \\\"TikTok\\\", \\\"Shorts\\\"],\n      \\\"estimated_duration\\\": 20\n    }\n  ]\n}",
        "batching": {
          "batchSize": 1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        384,
        -64
      ],
      "id": "2fd173ee-f222-4970-b717-7abdc151cbbf",
      "name": "Generate Video Script",
      "settings": {
        "errorHandling": "continueRegular"
      }
    },
    {
      "parameters": {
        "jsCode": "// Parse AI Script - Extracts ALL scripts and maps source_record_id from Filter node\nconst inputs = $input.all();  // Get ALL inputs from Gemini\nconst filterItems = $items('Filter: Status = Generate Script');  // Get output from Filter node\nconst output = [];\n\n// Create mapping of filter outputs indexed by position\nconst filterMap = {};\nfor (let i = 0; i < filterItems.length; i++) {\n  filterMap[i] = {\n    source_record_id: filterItems[i]?.json?.source_record_id || '',\n    source_post_id: filterItems[i]?.json?.source_post_id || ''\n  };\n}\n\n// Process ALL inputs (each input represents one Gemini response)\nfor (let inputIndex = 0; inputIndex < inputs.length; inputIndex++) {\n  const input = inputs[inputIndex];\n  const rawText = input.json.text || '';\n  \n  // Get source_record_id from the corresponding filter output\n  const filterData = filterMap[inputIndex] || { source_record_id: '', source_post_id: '' };\n  \n  let parsed = {};\n  try {\n    parsed = JSON.parse(rawText);\n  } catch (e) {\n    const jsonMatch = rawText.match(/\\{[\\s\\S]*\\}/);\n    if (jsonMatch) {\n      try {\n        parsed = JSON.parse(jsonMatch[0]);\n      } catch (e2) {}\n    }\n  }\n  \n  const scripts = parsed.scripts || [];\n  \n  // Process ALL scripts within each input\n  for (const script of scripts) {\n    if (script.scenes) {\n      const hook = script.scenes.filter(s => s.type === 'hook').map(s => s.text).join(' ');\n      const main = script.scenes.filter(s => s.type === 'main').map(s => s.text).join(' ');\n      const cta = script.scenes.filter(s => s.type === 'cta').map(s => s.text).join(' ');\n      const visuals = script.scenes.map(s => s.visual).join(' | ');\n      \n      output.push({\n        json: {\n          script_title: script.script_title || 'New Script',\n          source_record_id: filterData.source_record_id,\n          source_post_id: filterData.source_post_id,\n          hook: hook,\n          main_content: main,\n          cta: cta,\n          visual_cues: visuals,\n          tone: script.tone || 'Professional',\n          content_type_detected: script.content_type_detected || '',\n          script_style_applied: script.script_style_applied || '',\n          core_pain_targeted: script.core_pain_targeted || '',\n          target_platforms: script.target_platforms || ['Instagram'],\n          estimated_duration: script.estimated_duration || 20,\n          hashtags: script.hashtags || [],\n          variation: script.variation || 1\n        }\n      });\n    }\n  }\n}\n\nreturn output;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        720,
        -64
      ],
      "id": "parse-ai-script-id",
      "name": "Parse AI Script"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        592,
        96
      ],
      "id": "b0000ff6-0eb8-4e76-ba99-b98e3a00cf2c",
      "name": "Gemini 2.0 Script",
      "credentials": {
        "googlePalmApi": {
          "id": "igaSdthsiO1WHIs5",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "operation": "create",
        "base": {
          "__rl": true,
          "value": "={{ $env.AIRTABLE_BASE_ID }}",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "={{ $env.AT_TABLE_SCRIPT_LIB }}",
          "mode": "id"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Name": "={{ $json.script_title }}",
            "Source_Content_ID": "={{ $json.source_record_id }}",
            "Script_Title": "={{ $json.script_title }}",
            "Hook": "={{ $json.hook }}",
            "Main_Content": "={{ $json.main_content }}",
            "CTA ": "={{ $json.cta }}",
            "Visual_Cues": "={{ $json.visual_cues }}",
            "Tone": "={{ $json.tone }}",
            "Hashtags": "={{ Array.isArray($json.hashtags) ? $json.hashtags.join(', ') : ($json.hashtags || '') }}",
            "Estimated_Duration": "={{ $json.estimated_duration }}",
            "Target_Platforms ": "={{ Array.isArray($json.target_platforms) ? $json.target_platforms.join(', ') : $json.target_platforms }}",
            "Status": "Pending Approval",
            "Created_Date": "={{ $now.format('yyyy-MM-dd') }}"
          }
        },
        "options": {
          "typecast": true
        }
      },
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        928,
        -64
      ],
      "id": "45860e49-ffd7-4dc9-9dcf-c3e81e80b3ab",
      "name": "Store Script in Library",
      "credentials": {
        "airtableTokenApi": {
          "id": "h68hvDXg5Xigfz5P",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "content": "## ðŸŽ¬ STAGE 2: SCRIPT GENERATION\n\n",
        "height": 416,
        "width": 2552,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -368,
        -176
      ],
      "typeVersion": 1,
      "id": "a72a2661-8a64-408e-a6ee-d20191f40ad4",
      "name": "STAGE 2 - Script Generation"
    },
    {
      "parameters": {},
      "id": "5768a8b4-ff6b-4e3a-b0be-1b2c5c6b99fb",
      "name": "Trigger Generate Script",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        -256,
        -48
      ]
    },
    {
      "parameters": {
        "operation": "search",
        "base": {
          "__rl": true,
          "value": "={{ $env.AIRTABLE_BASE_ID }}",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "={{ $env.AT_TABLE_VIRAL_DB }}",
          "mode": "id"
        },
        "filterByFormula": "{Status} = 'Generate Script'",
        "options": {}
      },
      "id": "get-analyzed-content-id",
      "name": "Get Analyzed Content",
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        -32,
        -48
      ],
      "credentials": {
        "airtableTokenApi": {
          "id": "h68hvDXg5Xigfz5P",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "content": "## ðŸŽ¯ STAGE 1: CONTENT DISCOVERY PIPELINE\n\n### Flow:\n1ï¸âƒ£ Webhook Trigger â†’ Cron\n2ï¸âƒ£ Google Trends â†’ Viral Keywords\n3ï¸âƒ£ Apify Instagram Reel Scraper â†’ Reel Metadata + URLs\n4ï¸âƒ£ Loop Over Reels\n5ï¸âƒ£ FFmpeg (local) â†’ Extract Audio from Reel URL\n6ï¸âƒ£ Whisper API â†’ Transcription\n7ï¸âƒ£ Gemini â†’ Viral Analysis\n8ï¸âƒ£ Airtable â†’ Store in Viral Content DB\n\n### ENV VARS NEEDED:\n- AIRTABLE_BASE_ID\n- AT_TABLE_VIRAL_DB\n- APIFY_API_TOKEN\n- OPENAI_API_KEY (for Whisper)\n- GOOGLE_GEMINI_API_KEY\n- FFMPEG_TEMP_DIR (e.g. /tmp/reels)",
        "height": 828,
        "width": 6248,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -288,
        -1168
      ],
      "typeVersion": 1,
      "id": "note-stage1",
      "name": "STAGE 1 - Overview"
    },
    {
      "parameters": {
        "content": "## STEP 1: TRIGGER\nRuns on schedule or webhook.\nChange cron rule as needed.",
        "height": 180,
        "width": 400,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        320,
        -1280
      ],
      "typeVersion": 1,
      "id": "note-step1",
      "name": "Note Step1"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 12
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        464,
        -1056
      ],
      "id": "schedule-trigger-id",
      "name": "Schedule Trigger (Every 12h)"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        480,
        -832
      ],
      "id": "webhook-trigger-id",
      "name": "Manual Discovery Trigger"
    },
    {
      "parameters": {
        "content": "## STEP 2: GOOGLE TRENDS\nFetch trending topics from Google Trends RSS.\nParse XML â†’ extract keyword list.",
        "height": 180,
        "width": 400,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        752,
        -1280
      ],
      "typeVersion": 1,
      "id": "note-step2",
      "name": "Note Step2"
    },
    {
      "parameters": {
        "jsCode": "// Generate RSS URLs for 36 countries to maximize viral trend coverage\nconst geos = [\"US\", \"IN\", \"GB\", \"CA\", \"AU\", \"BR\", \"NG\", \"ID\", \"MX\", \"DE\", \"FR\", \"JP\", \"KR\", \"TR\", \"IT\", \"ES\", \"VN\", \"PH\", \"TH\", \"MY\", \"SG\", \"NZ\", \"IE\", \"NL\", \"BE\", \"CH\", \"AT\", \"SE\", \"NO\", \"DK\", \"PL\", \"IL\", \"ZA\", \"EG\", \"SA\", \"AE\"];\nreturn geos.map(geo => ({ json: { geo, url: `https://trends.google.com/trending/rss?geo=${geo}` } }));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        640,
        -992
      ],
      "id": "generate-global-urls-id",
      "name": "Generate Global URLs"
    },
    {
      "parameters": {
        "url": "={{ $json.url }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "text"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        848,
        -992
      ],
      "id": "google-trends-id",
      "name": "Fetch Google Trends RSS"
    },
    {
      "parameters": {
        "jsCode": "// Parse ALL Google Trends RSS feeds â†’ extract FULL metadata + descriptive keywords\nconst items = $input.all();\nconst allTrends = [];\n\nfor (const item of items) {\n  const xml = item.json.data || '';\n  const geo = item.json.geo || 'US';\n  \n  if (!xml || xml.length < 100) continue;\n  \n  // Extract each <item> block from RSS\n  const itemMatches = [...xml.matchAll(/<item>([\\s\\S]*?)<\\/item>/g)];\n  \n  for (const match of itemMatches) {\n    const inner = match[1];\n    \n    // Extract title (keyword)\n    const titleMatch = inner.match(/<title>(?:<!\\[CDATA\\[)?(.*?)(?:\\]\\]>)?<\\/title>/);\n    const title = titleMatch ? titleMatch[1].trim() : '';\n    if (!title || title === 'Daily Search Trends') continue;\n    \n    // Extract approx traffic / search volume\n    const trafficMatch = inner.match(/<ht:approx_traffic>(.*?)<\\/ht:approx_traffic>/);\n    const approx_traffic = trafficMatch ? trafficMatch[1].trim() : '0';\n    \n    // Extract ALL news item titles (context for the trend)\n    const newsItemTitles = [...inner.matchAll(/<ht:news_item_title>(?:<!\\[CDATA\\[)?(.*?)(?:\\]\\]>)?<\\/ht:news_item_title>/g)]\n      .map(m => m[1].trim());\n    \n    // Extract news item sources\n    const newsItemSources = [...inner.matchAll(/<ht:news_item_source>(.*?)<\\/ht:news_item_source>/g)]\n      .map(m => m[1].trim());\n    \n    // Extract news item URLs\n    const newsItemUrls = [...inner.matchAll(/<ht:news_item_url>(?:<!\\[CDATA\\[)?(.*?)(?:\\]\\]>)?<\\/ht:news_item_url>/g)]\n      .map(m => m[1].trim());\n    \n    // Extract picture URL\n    const picMatch = inner.match(/<ht:picture>(?:<!\\[CDATA\\[)?(.*?)(?:\\]\\]>)?<\\/ht:picture>/);\n    const picture = picMatch ? picMatch[1].trim() : '';\n    \n    // Extract pubDate\n    const pubDateMatch = inner.match(/<pubDate>(.*?)<\\/pubDate>/);\n    const pubDate = pubDateMatch ? pubDateMatch[1].trim() : '';\n    \n    // Parse traffic number for sorting\n    const trafficNum = parseInt(approx_traffic.replace(/[^0-9]/g, '')) || 0;\n    \n    // Build descriptive one-sentence keyword using news context\n    const newsContext = newsItemTitles.length > 0 ? newsItemTitles[0] : '';\n    const descriptive_keyword = newsContext \n      ? `${title} - ${newsContext}`\n      : title;\n    \n    allTrends.push({\n      trend_keyword: title,\n      descriptive_keyword: descriptive_keyword,\n      approx_traffic: approx_traffic,\n      traffic_number: trafficNum,\n      news_headlines: newsItemTitles.join(' | '),\n      news_sources: newsItemSources.join(', '),\n      news_urls: newsItemUrls.join(' | '),\n      picture_url: picture,\n      pub_date: pubDate,\n      geo: geo,\n      source: 'Google Trends',\n      fetched_at: new Date().toISOString()\n    });\n  }\n}\n\n// Deduplicate by keyword (case-insensitive)\nconst unique = [];\nconst seen = new Set();\nfor (const t of allTrends) {\n  const key = t.trend_keyword.toLowerCase();\n  if (!seen.has(key)) {\n    seen.add(key);\n    unique.push({ json: t });\n  }\n}\n\n// Sort by traffic (highest first)\nunique.sort((a, b) => (b.json.traffic_number || 0) - (a.json.traffic_number || 0));\n\nreturn unique;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        1056,
        -992
      ],
      "id": "parse-trends-id",
      "name": "Parse All Trends (Full Metadata)"
    },
    {
      "parameters": {
        "jsCode": "// Filter: Keep only VIRAL trends (high traffic) â€” target 500+\n// Keeps everything with 10k+ searches, sorted by traffic descending\nconst items = $input.all();\n\n// Filter: keep trends with meaningful search volume (10k+)\nconst viral = items.filter(item => {\n  const traffic = item.json.traffic_number || 0;\n  return traffic >= 10000;\n});\n\n// If less than 500 after filtering, include ALL trends (don't lose data)\nconst result = viral.length >= 100 ? viral : items;\n\n// Use descriptive keyword as the main trend_keyword for Apify search\nreturn result.map(item => ({\n  json: {\n    ...item.json,\n    trend_keyword: item.json.descriptive_keyword || item.json.trend_keyword\n  }\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        1264,
        -992
      ],
      "id": "limit-keywords-id",
      "name": "Filter Viral Trends (500+)"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=# VIRAL SCOUT â€” MILLION-LIKE POTENTIAL ANALYZER\n\nYou are a viral content analyst. Your job is to determine if this trending topic has REAL viral reel potential â€” the kind of content that gets millions of views on Instagram/TikTok.\n\n## TREND DATA\n- **Topic**: {{ $json.trend_keyword }}\n- **Search Volume**: {{ $json.approx_traffic }}\n- **News Context**: {{ $json.news_headlines || 'N/A' }}\n- **News Sources**: {{ $json.news_sources || 'N/A' }}\n- **Country**: {{ $json.geo }}\n- **Descriptive Keyword**: {{ $json.descriptive_keyword || $json.trend_keyword }}\n\n## VIRAL CATEGORIES (What we want):\n1. **Memes & Bizarre** â€” Penguin walking away from group, unusual animal behavior, absurd news\n2. **Tech & AI Breakthroughs** â€” GPT-5 launch, Chinese humanoid robots, new AI tools\n3. **Celebrity/CEO Moments** â€” Sundar Pichai robot meme, Elon tweets, viral CEO clips\n4. **Shocking News** â€” Court cases, scandals, unexpected revelations\n5. **Innovation & Science** â€” New inventions, space discoveries, medical breakthroughs\n6. **Cultural Phenomena** â€” Viral challenges, dance trends, unexpected heroes\n\n## WHAT TO REJECT:\n- Local sports scores (\"Team X beat Team Y 3-2\")\n- Weather reports\n- Stock market daily movements\n- Local politics with no viral hook\n- Generic celebrity gossip without a meme-worthy angle\n- Regular TV show episode releases\n\n## SCORING RULES:\n- **Tier S (95-100)**: Guaranteed viral. Massive search volume 1M+ AND meme/shock/innovation potential\n- **Tier A (85-94)**: Very high potential. 200k+ searches with strong visual/meme hook\n- **Tier B (70-84)**: Good potential. Has a unique angle that could work for reels\n- **Tier C (50-69)**: Maybe. Needs creative angle to work\n- **REJECT (0-49)**: Not worth Apify credits. Local noise, boring, no reel potential\n\n## YOUR TASK:\n1. Score the viral potential (0-100)\n2. Decide if it's a BANGER (worth spending Apify credits on)\n3. Create an OPTIMIZED Instagram search keyword â€” a vivid sentence for finding viral reels about this topic\n4. Identify the viral angle â€” what makes this topic shareable\n\n## OUTPUT (JSON ONLY, no markdown):\n{\n  \"viral_score\": 0,\n  \"is_banger\": true,\n  \"category\": \"Meme/Tech/Innovation/Bizarre/Celebrity/News\",\n  \"instagram_search_keyword\": \"Vivid one-sentence search phrase optimized for Instagram reel discovery\",\n  \"viral_angle\": \"Why this will go viral in one sentence\",\n  \"reject_reason\": \"Only fill if is_banger is false\"\n}",
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        1952,
        -992
      ],
      "id": "gemini-viral-scout-id",
      "name": "Gemini: Viral Scout",
      "settings": {
        "errorHandling": "continueRegular"
      },
      "onError": "continue"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        2000,
        -800
      ],
      "id": "gemini-scout-model-id",
      "name": "Gemini 2.0 (Scout)",
      "credentials": {
        "googlePalmApi": {
          "id": "igaSdthsiO1WHIs5",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parse Gemini Viral Scout results and filter only BANGERS\nconst items = $input.all();\nconst bangers = [];\n\nfor (const item of items) {\n  const rawText = item.json.text || item.json.output || '';\n  let analysis = {};\n  \n  try {\n    analysis = JSON.parse(rawText);\n  } catch(e) {\n    // Try to extract JSON from response\n    const jsonMatch = rawText.match(/\\{[\\s\\S]*\\}/);\n    if (jsonMatch) {\n      try { analysis = JSON.parse(jsonMatch[0]); } catch(e2) {}\n    }\n  }\n  \n  // Only keep bangers (is_banger === true AND viral_score >= 70)\n  if (analysis.is_banger === true && (analysis.viral_score || 0) >= 70) {\n    bangers.push({\n      json: {\n        // Use Gemini's optimized search keyword for Apify\n        trend_keyword: analysis.instagram_search_keyword || item.json.trend_keyword || '',\n        original_keyword: item.json.trend_keyword || '',\n        viral_score: analysis.viral_score || 0,\n        category: analysis.category || 'Unknown',\n        viral_angle: analysis.viral_angle || '',\n        approx_traffic: item.json.approx_traffic || '0',\n        traffic_number: item.json.traffic_number || 0,\n        news_headlines: item.json.news_headlines || '',\n        news_sources: item.json.news_sources || '',\n        picture_url: item.json.picture_url || '',\n        geo: item.json.geo || '',\n        source: item.json.source || 'Google Trends',\n        fetched_at: item.json.fetched_at || new Date().toISOString()\n      }\n    });\n  }\n}\n\n// Sort by viral score (highest first)\nbangers.sort((a, b) => (b.json.viral_score || 0) - (a.json.viral_score || 0));\n\n// Return all bangers (should be much less than 500, saving Apify credits)\nif (bangers.length === 0) {\n  return [{ json: { error: 'No viral bangers found this cycle', total_analyzed: items.length } }];\n}\n\nreturn bangers;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        2288,
        -992
      ],
      "id": "top-viral-bangers-id",
      "name": "Top Viral Bangers"
    },
    {
      "parameters": {
        "jsCode": "// Generate Reddit API URLs for viral subreddits\n// Using hot, rising, and top (past 24h) endpoints\nconst subreddits = ['all', 'technology', 'Futurology', 'worldnews', 'interestingasfuck', 'nextfuckinglevel', 'memes', 'science'];\nconst endpoints = [\n  { type: 'hot', suffix: 'hot.json?limit=30' },\n  { type: 'rising', suffix: 'rising.json?limit=30' },\n  { type: 'top', suffix: 'top.json?t=day&limit=30' }\n];\n\nconst urls = [];\nfor (const sub of subreddits) {\n  for (const ep of endpoints) {\n    urls.push({\n      json: {\n        url: `https://www.reddit.com/r/${sub}/${ep.suffix}`,\n        subreddit: sub,\n        endpoint_type: ep.type\n      }\n    });\n  }\n}\nreturn urls;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        640,
        -720
      ],
      "id": "generate-reddit-urls-id",
      "name": "Generate Reddit URLs"
    },
    {
      "parameters": {
        "url": "={{ $json.url }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "User-Agent",
              "value": "n8n-content-factory/1.0"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          },
          "timeout": 30000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        848,
        -720
      ],
      "id": "fetch-reddit-posts-id",
      "name": "Fetch Reddit Posts"
    },
    {
      "parameters": {
        "jsCode": "// Parse Reddit JSON responses â†’ normalize to same format as Google Trends\nconst items = $input.all();\nconst allPosts = [];\n\nfor (const item of items) {\n  const data = item.json.data || item.json;\n  const children = data?.children || [];\n  const subreddit = item.json.subreddit || 'all';\n  const endpointType = item.json.endpoint_type || 'hot';\n  \n  for (const child of children) {\n    const post = child.data || child;\n    if (!post || !post.title) continue;\n    \n    // Skip stickied/pinned posts\n    if (post.stickied) continue;\n    \n    const upvotes = post.ups || post.score || 0;\n    const comments = post.num_comments || 0;\n    const awards = post.total_awards_received || 0;\n    const upvoteRatio = post.upvote_ratio || 0;\n    \n    // Calculate engagement score\n    const engagementScore = upvotes + (comments * 2) + (awards * 10);\n    \n    allPosts.push({\n      trend_keyword: post.title,\n      descriptive_keyword: `${post.title} - r/${post.subreddit || subreddit}`,\n      approx_traffic: `${upvotes.toLocaleString()}+ upvotes`,\n      traffic_number: upvotes,\n      news_headlines: post.title,\n      news_sources: `Reddit r/${post.subreddit || subreddit}`,\n      news_urls: post.url || `https://reddit.com${post.permalink || ''}`,\n      picture_url: (post.thumbnail && post.thumbnail !== 'self' && post.thumbnail !== 'default') ? post.thumbnail : '',\n      pub_date: post.created_utc ? new Date(post.created_utc * 1000).toISOString() : new Date().toISOString(),\n      geo: 'Global',\n      source: 'Reddit',\n      reddit_subreddit: post.subreddit || subreddit,\n      reddit_endpoint: endpointType,\n      reddit_upvotes: upvotes,\n      reddit_comments: comments,\n      reddit_awards: awards,\n      reddit_upvote_ratio: upvoteRatio,\n      reddit_engagement: engagementScore,\n      reddit_permalink: `https://reddit.com${post.permalink || ''}`,\n      fetched_at: new Date().toISOString()\n    });\n  }\n}\n\n// Deduplicate by title\nconst unique = [];\nconst seen = new Set();\nfor (const p of allPosts) {\n  const key = p.trend_keyword.toLowerCase().substring(0, 80);\n  if (!seen.has(key)) {\n    seen.add(key);\n    unique.push({ json: p });\n  }\n}\n\n// Sort by engagement (highest first)\nunique.sort((a, b) => (b.json.reddit_engagement || 0) - (a.json.reddit_engagement || 0));\n\nreturn unique.length > 0 ? unique : [{ json: { error: 'No Reddit posts found', source: 'Reddit' } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        1056,
        -720
      ],
      "id": "parse-reddit-posts-id",
      "name": "Parse Reddit Posts"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        1568,
        -912
      ],
      "id": "merge-sources-id",
      "name": "Merge: Google Trends + Reddit"
    },
    {
      "parameters": {
        "operation": "create",
        "base": {
          "__rl": true,
          "value": "={{ $env.AIRTABLE_BASE_ID }}",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "={{ $env.AT_TABLE_INSPIRATION }}",
          "mode": "id"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Name": "={{ ($json.original_keyword || $json.trend_keyword || '').substring(0, 100) }}",
            "Platform": "={{ $json.source || 'Google Trends' }}",
            "Search_Keyword": "={{ $json.trend_keyword }}",
            "Category": "={{ $json.Category }}",
            "Viral_Score": "={{ $json.viral_score || 0 }}",
            "Viral_Angle": "={{ $json.Viral_Angle }}",
            "Approx_Traffic": "={{ $json.approx_traffic || '0' }}",
            "News_Context": "={{ ($json.news_headlines || '').substring(0, 500) }}",
            "Source_URL": "={{ $json.Source_URL }}",
            "Geo": "={{ $json.geo || 'Global' }}",
            "Status": "Pending",
            "Created_Date": "={{ $now.format('yyyy-MM-dd') }}"
          }
        },
        "options": {
          "typecast": true
        }
      },
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        2464,
        -992
      ],
      "id": "store-inspiration-id",
      "name": "Store in Inspiration DB",
      "credentials": {
        "airtableTokenApi": {
          "id": "h68hvDXg5Xigfz5P",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        2288,
        -720
      ],
      "id": "trigger-scraping-id",
      "name": "Trigger Scraping Run"
    },
    {
      "parameters": {
        "operation": "search",
        "base": {
          "__rl": true,
          "value": "={{ $env.AIRTABLE_BASE_ID }}",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "={{ $env.AT_TABLE_INSPIRATION }}",
          "mode": "id"
        },
        "filterByFormula": "{Status} = 'Pending'",
        "options": {}
      },
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        2464,
        -720
      ],
      "id": "read-inspiration-id",
      "name": "Read Inspiration DB (Pending)",
      "credentials": {
        "airtableTokenApi": {
          "id": "h68hvDXg5Xigfz5P",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=# INSTAGRAM REEL SEARCH OPTIMIZER\n\nYou are an expert in Instagram Reels and viral discovery. Your goal is to generate ONE highly effective SEARCH QUERY (a long, vivid descriptive phrase) that will help find the best viral reels for this topic.\n\n## TREND DATA\n- **Name**: {{ $json.Name }}\n- **Platform**: {{ $json.Platform }}\n- **Search Keyword**: {{ $json.Search_Keyword }}\n- **Viral Angle**: {{ $json.Viral_Angle }}\n- **Category**: {{ $json.Category }}\n\n## YOUR TASK:\n1. Analyze the trend and viral angle.\n2. Generate ONE short but vivid search phrase (e.g., \"elon musk robot meme 2024 viral\", \"funny penguin trip ice glitch\").\n3. Do not use # symbols. Just the phrase.\n\n## OUTPUT (JSON ONLY, no markdown):\n{\n  \"search_query\": \"The vivid search phrase optimized for Reel discovery\"\n}",
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        2688,
        -720
      ],
      "id": "gemini-hashtag-optimizer-id",
      "name": "Gemini: Hashtag Optimizer",
      "settings": {
        "errorHandling": "continueRegular"
      },
      "onError": "continue"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        2736,
        -528
      ],
      "id": "gemini-optimizer-model-id",
      "name": "Gemini 2.0 (Optimizer)",
      "credentials": {
        "googlePalmApi": {
          "id": "igaSdthsiO1WHIs5",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parse Gemini Keyword Optimizer results in BATCH mode\nconst items = $input.all();\nconst airtableRecords = $(\"Read Inspiration DB (Pending)\").all();\n\nreturn items.map((item, index) => {\n  const rawText = item.json.text || item.json.output || '';\n  let analysis = {};\n  \n  try {\n    analysis = JSON.parse(rawText);\n  } catch(e) {\n    const jsonMatch = rawText.match(/\\{[\\s\\S]*\\}/);\n    if (jsonMatch) {\n      try { analysis = JSON.parse(jsonMatch[0]); } catch(e2) {}\n    }\n  }\n\n  // Get corresponding Airtable record\n  const airtableData = airtableRecords[index]?.json || {};\n\n  // Fallback if no search_query found\n  const query = analysis.search_query || airtableData.Search_Keyword || \"\";\n\n  return {\n    json: {\n      ...airtableData,\n      optimized_query: query\n    }\n  };\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        2944,
        -720
      ],
      "id": "parse-hashtags-id",
      "name": "Parse Keywords"
    },
    {
      "parameters": {
        "content": "## STEP 3: APIFY SCRAPER\nUse Instagram Hashtag / Reel Scraper.\nActor: apify/instagram-reel-scraper\n(or apify/instagram-hashtag-scraper)\n\nReturns: url, likes, comments, views,\nfollowers, caption, timestamp etc.",
        "height": 220,
        "width": 440,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1296,
        -1312
      ],
      "typeVersion": 1,
      "id": "note-step3",
      "name": "Note Step3"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.apify.com/v2/acts/patient_discovery~instagram-search-reels/run-sync-get-dataset-items?token={{ $env.APIFY_API_TOKEN }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ {\n  \"query\": $json.optimized_query || $json.Search_Keyword,\n  \"resultsLimit\": 10\n} }}",
        "options": {
          "batching": {
            "batch": {
              "batchSize": 1
            }
          },
          "response": {
            "response": {
              "responseFormat": "json"
            }
          },
          "timeout": 120000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        3200,
        -720
      ],
      "id": "apify-scraper-id",
      "name": "Apify: Scrape Instagram Reels",
      "executeOnce": false,
      "notes": "Actor: apify~instagram-reel-scraper\nTimestamp: May take 30-60s. Sync mode returns results directly.\nIf timeout: switch to async run + poll dataset."
    },
    {
      "parameters": {
        "jsCode": "// Normalize Apify Instagram Reel Scraper output (Batch Mode)\nconst airtableKeywords = $items(\"Parse Keywords\");\nlet normalized = [];\n\nconst inputs = $input.all();\ninputs.forEach((input, index) => {\n  // Find the keyword that triggered this specific search\n  const keywordData = airtableKeywords[index] ? airtableKeywords[index].json : {};\n  const parentKeyword = keywordData.optimized_query || keywordData.Search_Keyword || \"\";\n\n  // Handle Apify's variable output structure\n  const raw = input.json;\n  let rawArray = [];\n  if (Array.isArray(raw)) {\n    rawArray = raw;\n  } else if (raw && raw.data && Array.isArray(raw.data)) {\n    rawArray = raw.data;\n  } else if (raw) {\n    rawArray = [raw];\n  }\n\n  // Filter and map this keyword's specific reels\n  const mappedReels = rawArray\n    .filter(item => item && (item.code || item.shortCode || item.shortcode || item.id || item.reel_id))\n    .map(item => {\n      const metrics = item.engagement_metrics || {};\n      const details = item.content_details || {};\n\n      return {\n        json: {\n          // Identity\n          content_code:   item.shortcode || item.code || item.shortCode || item.reel_id || item.id || '',\n          url:            item.url  || `https://www.instagram.com/reel/${item.shortcode || item.code || item.shortCode}/`,\n          video_url:      item.video_url || item.videoUrl || '',\n          platform:       'Instagram',\n\n          // Content / Caption\n          prompt:         details.caption || item.caption?.text || item.text || item.caption || '',\n          timestamp:      item.scraped_at || item.taken_at_ts || item.taken_at || item.timestamp || new Date().toISOString(),\n\n          // Engagement Metrics\n          likes:          metrics.like_count || item.like_count || item.likesCount || 0,\n          comments:       metrics.comment_count || item.comment_count || item.commentsCount || 0,\n          views:          metrics.play_count || item.ig_play_count || item.play_count || item.videoViewCount || 0,\n          shares:         metrics.share_count || item.share_count || item.sharesCount || 0,\n          saves:          metrics.save_count || item.savesCount || item.saves || 0,\n\n          // Subtitles (New)\n          subtitle_url:   item.video_subtitles_uri || '',\n\n          // Author Metadata\n          author:         item.creator?.username || item.user?.username || item.ownerUsername || item.username || '',\n          author_id:      item.creator?.id || item.user?.id || item.ownerId || item.userId || '',\n          followers:      item.creator?.follower_count || item.owner?.followedByCount || 0,\n\n          // Computed\n          engagement_rate: (\n            ((metrics.like_count || 0) + (metrics.comment_count || 0)) /\n            Math.max(metrics.play_count || item.ig_play_count || item.play_count || 1, 1) * 100\n          ).toFixed(2),\n\n          // Pass through optimized query\n          trend_keyword: parentKeyword\n        }\n      };\n    });\n    \n  normalized = normalized.concat(mappedReels);\n});\n\nreturn normalized.length > 0 ? normalized : [{ json: { error: 'No reels found', raw: $input.all() } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        3440,
        -720
      ],
      "id": "normalize-reels-id",
      "name": "Normalize Reel Metadata"
    },
    {
      "parameters": {
        "url": "={{ ($json.subtitle_url && $json.subtitle_url.startsWith('http')) ? $json.subtitle_url : 'https://httpbin.org/status/200' }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "text"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        3440,
        -960
      ],
      "id": "fetch-subtitles-id",
      "name": "Fetch Subtitles (SRT)",
      "onError": "continueRegular"
    },
    {
      "parameters": {
        "jsCode": "// Clean SRT subtitles into plain text and merge perfectly with original metadata\nconst originalItems = $items(\"Normalize Reel Metadata\");\n\nreturn $input.all().map((item, index) => {\n  const originalReel = originalItems[index] ? originalItems[index].json : {};\n  const srt = item.json.data || \"\";\n  let clean = \"\";\n  \n  if (originalReel.subtitle_url && typeof srt === 'string') {\n    clean = srt\n      .replace(/\\d+\\n\\d{2}:\\d{2}:\\d{2},\\d{3} --> \\d{2}:\\d{2}:\\d{2},\\d{3}/g, \"\")\n      .replace(/<[^>]*>/g, \"\")\n      .replace(/\\n\\s*\\n/g, \"\\n\")\n      .trim();\n  }\n\n  return {\n    json: {\n      ...originalReel,\n      transcript: clean || originalReel.prompt || \"\"\n    }\n  };\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        3648,
        -960
      ],
      "id": "clean-subtitles-id",
      "name": "Clean Subtitles"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=# ScaleBuild AI - Viral Content Analyst\n\n## Viral DNA\n- **Platform**: {{ $json.platform || 'Instagram' }}\n- **Post ID**: {{ $json.content_code }}\n- **Caption/Content**: {{ $json.prompt }}\n- **Transcript (Clean)**: {{ $json.transcript || $json.prompt || 'No transcript available' }}\n- **Likes**: {{ $json.likes }}\n- **Comments**: {{ $json.comments }}\n- **Views**: {{ $json.views }}\n- **Shares**: {{ $json.shares }}\n- **Saves**: {{ $json.saves }}\n- **Engagement Rate**: {{ $json.engagement_rate }}%\n- **Trend Keyword That Found This**: {{ $json.trend_keyword }}\n\n## Task\nAnalyze this viral reel and reverse-engineer its viral chemistry.\nFocus on the STORY, NARRATIVE HOOK, and what made it spread.\nUse the cleaned transcript as the PRIMARY source for understanding the content.\n\nOutput ONLY a valid JSON object. No markdown. No extra text.\n\n{\n  \"viral_score\": 0,\n  \"engagement_score\": 0,\n  \"narrative_hook\": \"\",\n  \"content_structure\": \"\",\n  \"emotional_triggers\": \"\",\n  \"viral_elements\": \"\",\n  \"script_framework\": \"\",\n  \"hook_pattern\": \"\"\n}",
        "batching": {
          "batchSize": 1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        5040,
        -960
      ],
      "id": "analyze-viral-id",
      "name": "Analyze Viral Content (Gemini)",
      "settings": {
        "errorHandling": "continueRegular"
      },
      "onError": "continue"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        5104,
        -752
      ],
      "id": "gemini-model-id",
      "name": "Gemini 2.0 Flash",
      "credentials": {
        "googlePalmApi": {
          "id": "igaSdthsiO1WHIs5",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parse Gemini's JSON response and perfectly sync with clean metadata\nconst originalItems = $items(\"Clean Subtitles\");\n\nreturn $input.all().map((item, index) => {\n  const originalReel = originalItems[index] ? originalItems[index].json : {};\n  const rawText = item.json.text || item.json.output || '';\n  \n  let analysis = {};\n  try {\n    analysis = JSON.parse(rawText);\n  } catch(e) {\n    // Try to extract JSON block\n    const match = rawText.match(/\\{[\\s\\S]*\\}/);\n    if (match) {\n      try { analysis = JSON.parse(match[0]); } catch(e2) {}\n    }\n  }\n\n  const toString = (val) => {\n    if (val === undefined || val === null) return '';\n    if (typeof val === 'object') return JSON.stringify(val);\n    return String(val);\n  };\n\n  return {\n    json: {\n      ...originalReel,\n      // Gemini Analysis\n      viral_score:        analysis.viral_score || 0,\n      engagement_score:   analysis.engagement_score || 0,\n      narrative_hook:     toString(analysis.narrative_hook || analysis.hook_pattern),\n      hook_pattern:       toString(analysis.hook_pattern   || analysis.narrative_hook),\n      content_structure:  toString(analysis.content_structure),\n      emotional_triggers: toString(analysis.emotional_triggers),\n      viral_elements:     toString(analysis.viral_elements),\n      script_framework:   toString(analysis.script_framework)\n    }\n  };\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        5344,
        -960
      ],
      "id": "parse-gemini-id",
      "name": "Parse Gemini Analysis"
    },
    {
      "parameters": {
        "content": "## STEP 8: STORE IN AIRTABLE\nStores all metadata + transcript +\nGemini analysis into Viral Content DB.\n\nAirtable Columns Used:\nName, Post_ID, Platform, Post_URL,\nContent, Engagement_Score, Likes,\nComments, Views, Shares, Saves,\nFollowers, Engagement_Rate, Viral_Score,\nHook_Pattern, Content_Structure,\nEmotional_Triggers, Viral_Elements,\nScript_Framework, Transcript,\nStatus, Created_Date",
        "height": 320,
        "width": 420,
        "color": 2
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        4256,
        -1424
      ],
      "typeVersion": 1,
      "id": "note-step8",
      "name": "Note Step8"
    },
    {
      "parameters": {
        "operation": "create",
        "base": {
          "__rl": true,
          "value": "={{ $env.AIRTABLE_BASE_ID }}",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "={{ $env.AT_TABLE_VIRAL_DB }}",
          "mode": "id"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Name": "={{ ($json.prompt || $json.content_code || 'Reel').substring(0, 50) }}",
            "Post_ID": "={{ $json.content_code }}",
            "Platform": "={{ $json.platform || 'Instagram' }}",
            "Post_URL": "={{ $json.url }}",
            "Content": "={{ $json.prompt }}",
            "Engagement_Score": "={{ $json.engagement_score }}",
            "Likes_Reactions_Upvotes": "={{ $json.likes }}",
            "Comments": "={{ $json.comments }}",
            "Views": "={{ $json.views }}",
            "Shares": "={{ $json.shares }}",
            "Shares_Awards": "={{ $json.shares }}",
            "Saves": "={{ $json.saves }}",
            "Followers": "={{ $json.followers }}",
            "Engagement_Rate": "={{ $json.engagement_rate }}",
            "Viral_Score": "={{ $json.viral_score }}",
            "Hook_Pattern": "={{ $json.hook_pattern }}",
            "Content_Structure": "={{ $json.content_structure }}",
            "Emotional_Triggers": "={{ $json.emotional_triggers }}",
            "Viral_Elements ": "={{ $json.viral_elements }}",
            "Script_Framework": "={{ $json.script_framework }}",
            "Transcript": "={{ $json.transcript }}",
            "Status": "Analyzed",
            "Created_Date": "={{ $now.format('yyyy-MM-dd') }}"
          }
        },
        "options": {
          "typecast": true
        }
      },
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        5600,
        -960
      ],
      "id": "store-viral-db-id",
      "name": "Store in Viral Content DB",
      "credentials": {
        "airtableTokenApi": {
          "id": "h68hvDXg5Xigfz5P",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "s1",
              "name": "full_script",
              "value": "PASTE YOUR FULL SCRIPT HERE. This is the text your avatar will speak on camera. Make sure it is natural spoken language.",
              "type": "string"
            },
            {
              "id": "s2",
              "name": "script_title",
              "value": "My Video Title",
              "type": "string"
            },
            {
              "id": "s3",
              "name": "estimated_duration",
              "value": 25,
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "id": "33de8009-cdc6-401a-8077-b64a922ed48a",
      "name": "ðŸ“ Set Script + Config",
      "type": "n8n-nodes-base.set",
      "position": [
        2720,
        0
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "jsCode": "const item = $input.first().json;\nreturn [{\n  json: {\n    script_title: item.script_title,\n    full_script: item.full_script,\n    estimated_duration: item.estimated_duration,\n    text: item.full_script,\n    model_id: 'eleven_multilingual_v2',\n    voice_settings: {\n      stability: 0.5,\n      similarity_boost: 0.75,\n      style: 0.0,\n      use_speaker_boost: true\n    }\n  }\n}];"
      },
      "id": "f3f91b16-9f68-4f2c-bc73-a3ee43ad2333",
      "name": "ðŸ”§ Prepare ElevenLabs Request",
      "type": "n8n-nodes-base.code",
      "position": [
        2928,
        0
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.elevenlabs.io/v1/text-to-speech/{{ $env.ELEVENLABS_VOICE_ID }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "xi-api-key",
              "value": "={{ $env.ELEVENLABS_API_KEY }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ { text: $json.text, model_id: $json.model_id, voice_settings: $json.voice_settings } }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "id": "c775a471-8302-4d9f-bc2a-c1ffac1a24a6",
      "name": "ðŸŽ™ï¸ Generate Voice (ElevenLabs)",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        3120,
        0
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "const item = $input.first();\nconst prev = $node['Prepare ElevenLabs Request'].json;\nreturn [{\n  json: {\n    script_title: prev.script_title,\n    full_script: prev.full_script,\n    estimated_duration: prev.estimated_duration\n  },\n  binary: item.binary\n}];"
      },
      "id": "40374f14-2e13-4a15-9ee1-80bb47613bc7",
      "name": "ðŸ“Ž Attach Audio + Carry Metadata",
      "type": "n8n-nodes-base.code",
      "position": [
        3328,
        0
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://upload.heygen.com/v1/asset",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Api-Key",
              "value": "={{ $env.HEYGEN_API_KEY }}"
            },
            {
              "name": "Content-Type",
              "value": "audio/mpeg"
            }
          ]
        },
        "sendBody": true,
        "contentType": "binaryData",
        "inputDataFieldName": "data",
        "options": {}
      },
      "id": "d25f318b-4cc5-41b5-a1f1-db4260791799",
      "name": "â˜ï¸ Upload Audio to HeyGen",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        3520,
        0
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "const uploadResult = $input.first().json;\nconst meta = $node['Attach Audio + Carry Metadata'].json;\nconst audioAssetId = uploadResult?.data?.id || uploadResult?.id || uploadResult?.asset_id || '';\n\nif (!audioAssetId) {\n  throw new Error('HeyGen audio upload failed. Response: ' + JSON.stringify(uploadResult));\n}\n\nreturn [{ json: { ...meta, audio_asset_id: audioAssetId } }];"
      },
      "id": "3ecd425d-ac56-4d23-bc2e-76bc9adc4ab9",
      "name": "ðŸ”— Extract Audio Asset ID",
      "type": "n8n-nodes-base.code",
      "position": [
        3728,
        0
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "const item = $input.first().json;\nconst avatarId = $env.HEYGEN_AVATAR_ID;\nconst audioAssetId = item.audio_asset_id;\n\nreturn [{\n  json: {\n    ...item,\n    heygen_request_body: {\n      test: false,\n      video_inputs: [\n        {\n          character: {\n            type: 'avatar',\n            avatar_id: avatarId,\n            avatar_style: 'normal',\n            scale: 1.0\n          },\n          voice: {\n            type: 'audio',\n            audio_asset_id: audioAssetId\n          },\n          background: {\n            type: 'color',\n            value: '#00FF00'\n          }\n        }\n      ],\n      dimension: {\n        width: 1080,\n        height: 1920\n      },\n      caption: false\n    }\n  }\n}];"
      },
      "id": "5c847448-1bc1-406e-b1ee-f0986497fa29",
      "name": "ðŸ—ï¸ Build HeyGen Video Request",
      "type": "n8n-nodes-base.code",
      "position": [
        3920,
        0
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.heygen.com/v2/video/generate",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Api-Key",
              "value": "={{ $env.HEYGEN_API_KEY }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.heygen_request_body }}",
        "options": {}
      },
      "id": "648ffab9-15f7-4dd1-88ae-64858ae98111",
      "name": "ðŸŽ¬ Submit HeyGen Video Generation",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        4128,
        0
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "const response = $input.first().json;\nconst meta = $node['Build HeyGen Video Request'].json;\nconst videoId = response?.data?.video_id || response?.video_id || '';\n\nif (!videoId) {\n  throw new Error('HeyGen submission failed: ' + JSON.stringify(response));\n}\n\nreturn [{ json: { ...meta, heygen_video_id: videoId } }];"
      },
      "id": "04c516ac-a7d0-4b33-9ea0-e5b307b84783",
      "name": "ðŸ“Œ Extract HeyGen Video ID",
      "type": "n8n-nodes-base.code",
      "position": [
        4320,
        0
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "amount": 10,
        "unit": "minutes"
      },
      "id": "7f8eab22-eb40-4ff7-9370-4559f438434e",
      "name": "â³ Wait 10 Min (HeyGen Processing)",
      "type": "n8n-nodes-base.wait",
      "position": [
        4528,
        0
      ],
      "webhookId": "heygen-wait-01",
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "url": "=https://api.heygen.com/v1/video_status.get?video_id={{ $json.heygen_video_id }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Api-Key",
              "value": "={{ $env.HEYGEN_API_KEY }}"
            }
          ]
        },
        "options": {}
      },
      "id": "67578ef6-0f9d-4050-986d-3791fce9e9d0",
      "name": "ðŸ” Poll HeyGen Status",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        4720,
        0
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "const pollResult = $input.first().json;\nconst meta = $node['Extract HeyGen Video ID'].json;\nreturn [{ json: { ...meta, poll_status: pollResult?.data?.status, video_url: pollResult?.data?.video_url } }];"
      },
      "id": "da702cf0-37f7-47e9-9e0f-e5bc260d7d58",
      "name": "ðŸ” Re-attach Metadata for Poll",
      "type": "n8n-nodes-base.code",
      "position": [
        4720,
        160
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "heygen-status-check",
              "operator": {
                "name": "filter.operator.equals",
                "type": "string",
                "operation": "equals"
              },
              "leftValue": "={{ $json.poll_status }}",
              "rightValue": "completed"
            }
          ]
        },
        "options": {}
      },
      "id": "8cbf7907-a998-47a5-a372-5049051aef4b",
      "name": "âœ… HeyGen Complete?",
      "type": "n8n-nodes-base.if",
      "position": [
        4928,
        0
      ],
      "typeVersion": 2.2
    },
    {
      "parameters": {
        "unit": "minutes"
      },
      "id": "92813b31-628e-4b55-8106-4e7256d186e1",
      "name": "â° Wait 5 Min (Retry)",
      "type": "n8n-nodes-base.wait",
      "position": [
        5120,
        160
      ],
      "webhookId": "heygen-retry-01",
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "r1",
              "name": "heygen_video_id",
              "value": "={{ $json.heygen_video_id }}",
              "type": "string"
            },
            {
              "id": "r2",
              "name": "heygen_video_url",
              "value": "={{ $json.video_url }}",
              "type": "string"
            },
            {
              "id": "r3",
              "name": "script_title",
              "value": "={{ $json.script_title }}",
              "type": "string"
            },
            {
              "id": "r4",
              "name": "full_script",
              "value": "={{ $json.full_script }}",
              "type": "string"
            },
            {
              "id": "r5",
              "name": "estimated_duration",
              "value": "={{ $json.estimated_duration }}",
              "type": "number"
            },
            {
              "id": "r6",
              "name": "status",
              "value": "completed",
              "type": "string"
            },
            {
              "id": "r7",
              "name": "note",
              "value": "Copy heygen_video_id and heygen_video_url â€” use these in the Submagic workflow",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "fa42470a-d93f-4c78-9c87-3abbb6c26bdb",
      "name": "ðŸ’¾ Save HeyGen Video URL",
      "type": "n8n-nodes-base.set",
      "position": [
        5120,
        -96
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "jsCode": "const item = $input.first().json;\nconsole.log('=== HEYGEN TALKING HEAD COMPLETE ===');\nconsole.log('Video ID:', item.heygen_video_id);\nconsole.log('Video URL:', item.heygen_video_url);\nconsole.log('Script:', item.script_title);\nconsole.log('Duration:', item.estimated_duration, 'seconds');\nconsole.log('\\n>>> COPY THESE FOR SUBMAGIC WORKFLOW <<<');\nconsole.log('heygen_video_id:', item.heygen_video_id);\nconsole.log('heygen_video_url:', item.heygen_video_url);\nreturn [{ json: item }];"
      },
      "id": "46764dc9-25e0-4902-85bc-989a3004c95c",
      "name": "âœ… DONE â€” Log Output",
      "type": "n8n-nodes-base.code",
      "position": [
        5328,
        -96
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "content": "## ðŸŽ­ STANDALONE 1 â€” HeyGen Talking Head\n\n### What This Does:\n1. Takes your script text\n2. Generates voice via ElevenLabs\n3. Uploads audio to HeyGen\n4. Creates avatar video with GREEN SCREEN background\n5. Polls until complete\n6. Outputs video URL + ID\n\n### ENV VARS Required:\n- `ELEVENLABS_API_KEY`\n- `ELEVENLABS_VOICE_ID`\n- `HEYGEN_API_KEY`\n- `HEYGEN_AVATAR_ID`\n\n### Output to Copy:\n- `heygen_video_id`\n- `heygen_video_url`\nâ†’ Use these in Submagic Workflow",
        "height": 340,
        "width": 640,
        "color": 6
      },
      "id": "8513b532-47fb-4397-9c84-cacae632f548",
      "name": "Sticky â€” Overview",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2496,
        -208
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## âš™ï¸ Edit Here\nPaste your script in **Set Script + Config** node.\n\nSet ENV VARS in n8n settings.",
        "height": 180,
        "width": 180,
        "color": 3
      },
      "id": "0be632de-6d57-403f-b45f-517eff3a744e",
      "name": "Sticky â€” Config",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2704,
        -208
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=You are a video production AI. Split this script into individual scenes for b-roll generation.\n\nScript: {{ $json.full_script }}\nTone: {{ $json.video_tone }}\nStyle: {{ $json.video_style }}\n\nFor EACH scene:\n1. Extract the exact script line\n2. Estimate duration in seconds (average 2.5-3 words per second)\n3. Generate a detailed VEO3 b-roll visual prompt that matches the MEANING of that line â€” NOT copying the words literally. Think visually. What would a documentary filmmaker shoot for that moment?\n4. Make each prompt rich: include camera movement, lighting, setting, color palette, mood. No text, no subtitles, no people speaking directly to camera.\n\nReturn ONLY valid JSON, no markdown:\n{\n  \"scenes\": [\n    {\n      \"scene_number\": 1,\n      \"script_line\": \"exact words\",\n      \"duration_sec\": 5,\n      \"broll_prompt\": \"Cinematic slow push-in shot of [detailed visual]. [Camera]. [Lighting]. [Color palette]. No text, no subtitles, photorealistic, 9:16 vertical.\"\n    }\n  ],\n  \"total_scenes\": 3,\n  \"total_duration_sec\": 25\n}",
        "hasOutputParser": true,
        "batching": {}
      },
      "id": "7dd44bb0-ca16-46a9-a162-bb6953c150ad",
      "name": "ðŸ¤– Claude â€” Split Script into Scenes",
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "position": [
        3072,
        784
      ],
      "typeVersion": 1.7
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "claude-sonnet-4-20250514",
          "cachedResultName": "Claude Sonnet 4"
        },
        "options": {}
      },
      "id": "69c887ab-0a9b-44e5-ae46-c5b9c9dc0cdd",
      "name": "ðŸ§  Claude Sonnet",
      "type": "@n8n/n8n-nodes-langchain.lmChatAnthropic",
      "position": [
        3072,
        960
      ],
      "typeVersion": 1.3
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"scenes\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"scene_number\": { \"type\": \"number\" },\n          \"script_line\": { \"type\": \"string\" },\n          \"duration_sec\": { \"type\": \"number\" },\n          \"broll_prompt\": { \"type\": \"string\" }\n        }\n      }\n    },\n    \"total_scenes\": { \"type\": \"number\" },\n    \"total_duration_sec\": { \"type\": \"number\" }\n  }\n}",
        "autoFix": true
      },
      "id": "96655b27-4787-46e9-a94f-153a768c9aa9",
      "name": "ðŸ“‹ Scene Output Parser",
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "position": [
        3264,
        960
      ],
      "typeVersion": 1.3
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "ps1",
              "name": "scenes",
              "value": "={{ $json.output.scenes }}",
              "type": "array"
            },
            {
              "id": "ps2",
              "name": "total_scenes",
              "value": "={{ $json.output.total_scenes }}",
              "type": "number"
            },
            {
              "id": "ps3",
              "name": "total_duration_sec",
              "value": "={{ $json.output.total_duration_sec }}",
              "type": "number"
            },
            {
              "id": "ps4",
              "name": "script_title",
              "value": "={{ $('ðŸ“ Set Script + Config1').item.json.script_title }}",
              "type": "string"
            },
            {
              "id": "ps5",
              "name": "video_style",
              "value": "={{ $('ðŸ“ Set Script + Config1').item.json.video_style }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "d4afd8bc-7c1a-41b3-89a5-b44ef4e738d0",
      "name": "ðŸ“¦ Store Parsed Scenes",
      "type": "n8n-nodes-base.set",
      "position": [
        3312,
        784
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "fieldToSplitOut": "scenes",
        "options": {}
      },
      "id": "f2c5d5e3-afb8-4868-b783-f97d48d01950",
      "name": "ðŸ”€ Split Scenes (One Per Item)",
      "type": "n8n-nodes-base.splitOut",
      "position": [
        3552,
        784
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "cs1",
              "name": "scene_number",
              "value": "={{ $json.scene_number }}",
              "type": "number"
            },
            {
              "id": "cs2",
              "name": "script_line",
              "value": "={{ $json.script_line }}",
              "type": "string"
            },
            {
              "id": "cs3",
              "name": "duration_sec",
              "value": "={{ $json.duration_sec }}",
              "type": "number"
            },
            {
              "id": "cs4",
              "name": "broll_prompt",
              "value": "={{ $json.broll_prompt }}",
              "type": "string"
            },
            {
              "id": "cs5",
              "name": "script_title",
              "value": "={{ $('ðŸ“¦ Store Parsed Scenes').item.json.script_title }}",
              "type": "string"
            },
            {
              "id": "cs6",
              "name": "total_scenes",
              "value": "={{ $('ðŸ“¦ Store Parsed Scenes').item.json.total_scenes }}",
              "type": "number"
            },
            {
              "id": "cs7",
              "name": "total_duration_sec",
              "value": "={{ $('ðŸ“¦ Store Parsed Scenes').item.json.total_duration_sec }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "id": "7aac018b-3447-4c18-9b60-8448e246478c",
      "name": "ðŸŽžï¸ Set Current Scene Data",
      "type": "n8n-nodes-base.set",
      "position": [
        3776,
        784
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://queue.fal.run/fal-ai/veo3",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Key {{ $env.FAL_AI_API_KEY }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={\n  \"prompt\": \"{{ $json.broll_prompt }} Duration: {{ $json.duration_sec }} seconds. No talking heads, no direct camera address, no subtitles, no text overlays.\",\n  \"aspect_ratio\": \"9:16\",\n  \"duration\": \"8s\"\n}",
        "options": {
          "batching": {
            "batch": {
              "batchSize": 1,
              "batchInterval": 5000
            }
          }
        }
      },
      "id": "b3b03f93-cb2c-4182-95d8-56bfd43a6d7c",
      "name": "ðŸŽ¥ VEO3 â€” Submit B-Roll Job",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        4016,
        784
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "vr1",
              "name": "veo3_request_id",
              "value": "={{ $json.request_id }}",
              "type": "string"
            },
            {
              "id": "vr2",
              "name": "scene_number",
              "value": "={{ $('ðŸŽžï¸ Set Current Scene Data').item.json.scene_number }}",
              "type": "number"
            },
            {
              "id": "vr3",
              "name": "script_line",
              "value": "={{ $('ðŸŽžï¸ Set Current Scene Data').item.json.script_line }}",
              "type": "string"
            },
            {
              "id": "vr4",
              "name": "duration_sec",
              "value": "={{ $('ðŸŽžï¸ Set Current Scene Data').item.json.duration_sec }}",
              "type": "number"
            },
            {
              "id": "vr5",
              "name": "broll_prompt",
              "value": "={{ $('ðŸŽžï¸ Set Current Scene Data').item.json.broll_prompt }}",
              "type": "string"
            },
            {
              "id": "vr6",
              "name": "script_title",
              "value": "={{ $('ðŸŽžï¸ Set Current Scene Data').item.json.script_title }}",
              "type": "string"
            },
            {
              "id": "vr7",
              "name": "total_scenes",
              "value": "={{ $('ðŸŽžï¸ Set Current Scene Data').item.json.total_scenes }}",
              "type": "number"
            },
            {
              "id": "vr8",
              "name": "total_duration_sec",
              "value": "={{ $('ðŸŽžï¸ Set Current Scene Data').item.json.total_duration_sec }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "id": "039853a1-74ba-448b-ae7c-c2d0ec2e1578",
      "name": "ðŸ“Œ Save VEO3 Request ID",
      "type": "n8n-nodes-base.set",
      "position": [
        4224,
        784
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "unit": "minutes"
      },
      "id": "82aa6165-15c3-4499-b43c-8b55bfb25f07",
      "name": "â³ Wait 5 Min (VEO3 Processing)",
      "type": "n8n-nodes-base.wait",
      "position": [
        4448,
        784
      ],
      "webhookId": "veo3-wait-01",
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "url": "=https://queue.fal.run/fal-ai/veo3/requests/{{ $json.veo3_request_id }}/status",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Key {{ $env.FAL_AI_API_KEY }}"
            }
          ]
        },
        "options": {}
      },
      "id": "2205c215-36a5-448c-b6cb-20936d82322d",
      "name": "ðŸ” Poll VEO3 Status",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        4672,
        784
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "const pollResult = $input.first().json;\nconst meta = $node['Save VEO3 Request ID'].json;\nreturn [{ json: { ...meta, veo3_poll_status: (pollResult.status || '').toUpperCase() } }];"
      },
      "id": "b064f4f1-c32b-4921-b961-62c4fc1da7ca",
      "name": "ðŸ” Re-attach Scene Metadata",
      "type": "n8n-nodes-base.code",
      "position": [
        4672,
        960
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "caseSensitive": false,
            "typeValidation": "strict"
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "veo3-status-check",
              "operator": {
                "name": "filter.operator.equals",
                "type": "string",
                "operation": "equals"
              },
              "leftValue": "={{ $json.veo3_poll_status }}",
              "rightValue": "COMPLETED"
            }
          ]
        },
        "options": {}
      },
      "id": "758e7d6c-dcde-4284-9665-034e0593f277",
      "name": "âœ… VEO3 Complete?",
      "type": "n8n-nodes-base.if",
      "position": [
        4896,
        784
      ],
      "typeVersion": 2.2
    },
    {
      "parameters": {
        "amount": 3,
        "unit": "minutes"
      },
      "id": "a26f8925-477f-4334-a657-79b08354218b",
      "name": "â° Wait 3 Min (VEO3 Retry)",
      "type": "n8n-nodes-base.wait",
      "position": [
        5104,
        944
      ],
      "webhookId": "veo3-retry-01",
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "url": "=https://queue.fal.run/fal-ai/veo3/requests/{{ $json.veo3_request_id }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Key {{ $env.FAL_AI_API_KEY }}"
            }
          ]
        },
        "options": {}
      },
      "id": "8e49af7c-238b-4f45-9e28-b6bffa53a473",
      "name": "ðŸ“¥ Fetch VEO3 Video Result",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        5104,
        688
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "const response = $input.first().json;\nconst meta = $node['Save VEO3 Request ID'].json;\n\nconst videoUrl = response?.video?.url\n  || response?.result?.video?.url\n  || response?.output?.video?.url\n  || response?.video_url\n  || '';\n\nif (!videoUrl) {\n  throw new Error('VEO3 did not return a video URL: ' + JSON.stringify(response));\n}\n\nreturn [{\n  json: {\n    scene_number: meta.scene_number,\n    script_line: meta.script_line,\n    duration_sec: meta.duration_sec,\n    broll_prompt: meta.broll_prompt,\n    broll_video_url: videoUrl,\n    veo3_request_id: meta.veo3_request_id,\n    script_title: meta.script_title,\n    total_scenes: meta.total_scenes,\n    total_duration_sec: meta.total_duration_sec,\n    status: 'completed'\n  }\n}];"
      },
      "id": "c6423aaa-bc32-4549-8691-3a770520ff2e",
      "name": "ðŸ’¾ Extract + Save B-Roll URL",
      "type": "n8n-nodes-base.code",
      "position": [
        5328,
        688
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "options": {}
      },
      "id": "c66b915c-dc9b-477b-871f-b59735594ce4",
      "name": "ðŸ§© Aggregate All B-Roll Clips",
      "type": "n8n-nodes-base.aggregate",
      "position": [
        5552,
        688
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "jsCode": "const allScenes = $input.first().json.data;\n\n// Sort by scene number\nallScenes.sort((a, b) => a.scene_number - b.scene_number);\n\n// Build summary log\nconsole.log('=== VEO3 B-ROLL GENERATION COMPLETE ===');\nconsole.log('Script:', allScenes[0]?.script_title);\nconsole.log('Total Scenes:', allScenes.length);\nconsole.log('Total Duration:', allScenes[0]?.total_duration_sec, 'seconds');\nconsole.log('');\n\nallScenes.forEach(scene => {\n  console.log(`Scene ${scene.scene_number} (${scene.duration_sec}s):`);\n  console.log(`  Script: ${scene.script_line}`);\n  console.log(`  B-Roll URL: ${scene.broll_video_url}`);\n  console.log('');\n});\n\nconsole.log('>>> COPY THESE URLs INTO SUBMAGIC WORKFLOW <<<');\nallScenes.forEach(s => {\n  console.log(`Scene ${s.scene_number}: ${s.broll_video_url}`);\n});\n\nreturn [{\n  json: {\n    script_title: allScenes[0]?.script_title,\n    total_scenes: allScenes.length,\n    total_duration_sec: allScenes[0]?.total_duration_sec,\n    scenes_summary: allScenes.map(s => ({\n      scene_number: s.scene_number,\n      script_line: s.script_line,\n      duration_sec: s.duration_sec,\n      broll_video_url: s.broll_video_url,\n      veo3_request_id: s.veo3_request_id\n    })),\n    all_broll_urls: allScenes.map(s => s.broll_video_url),\n    note: 'Copy scenes_summary and all_broll_urls into the Submagic workflow'\n  }\n}];"
      },
      "id": "9f213257-9697-49fb-b39c-7ab71c80b492",
      "name": "ðŸ“Š Build Final Summary",
      "type": "n8n-nodes-base.code",
      "position": [
        5776,
        688
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "v1",
              "name": "full_script",
              "value": "AI is changing everything. Companies are saving millions using automation. And honestly, you are already missing out. Here is what you need to know right now.",
              "type": "string"
            },
            {
              "id": "v2",
              "name": "script_title",
              "value": "My Video Title",
              "type": "string"
            },
            {
              "id": "v3",
              "name": "video_tone",
              "value": "urgent, eye-opening, business-focused",
              "type": "string"
            },
            {
              "id": "v4",
              "name": "video_style",
              "value": "cinematic, photorealistic, 9:16 vertical, no text, no subtitles",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "4d199ff7-ecf7-41b9-abc0-ea3e8f22553f",
      "name": "ðŸ“ Set Script + Config1",
      "type": "n8n-nodes-base.set",
      "position": [
        2848,
        784
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "content": "## ðŸŽ¥ STANDALONE 2 â€” VEO3 B-Roll Generator\n\n### What This Does:\n1. Takes your script text\n2. Claude splits it into scenes with timing\n3. Claude generates a detailed VEO3 visual prompt per scene\n4. VEO3 generates one 8-second b-roll clip per scene\n5. Polls until all clips complete\n6. Outputs all b-roll URLs with scene timing\n\n### ENV VARS Required:\n- `FAL_AI_API_KEY`\n- Anthropic credential set in n8n\n\n### Output to Copy:\n- `scenes_summary` array (scene_number, duration, url)\n- `all_broll_urls` list\nâ†’ Use these in Submagic Workflow\n\n### Note on VEO3 Limits:\nVEO3 max = 8 seconds per clip.\nIf scene needs 12s, FFmpeg trims/loops in Submagic workflow.",
        "height": 380,
        "width": 660,
        "color": 4
      },
      "id": "13410db1-f28a-4a6f-985e-0715367d027d",
      "name": "Sticky â€” Overview1",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2624,
        576
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## âš™ï¸ Edit Here\nPaste your script in **Set Script + Config** node.\n\nAdjust tone and style fields to match your video.",
        "height": 180,
        "width": 180,
        "color": 3
      },
      "id": "cfa29aaf-32e7-4b4b-99b9-0773e03ab149",
      "name": "Sticky â€” Config1",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2848,
        576
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "i1",
              "name": "script_title",
              "value": "My Video Title",
              "type": "string"
            },
            {
              "id": "i2",
              "name": "heygen_video_url",
              "value": "PASTE_HEYGEN_VIDEO_URL_HERE",
              "type": "string"
            },
            {
              "id": "i3",
              "name": "total_duration_sec",
              "value": 25,
              "type": "number"
            },
            {
              "id": "i4",
              "name": "scenes_json",
              "value": "[{\"scene_number\":1,\"script_line\":\"AI is changing everything\",\"duration_sec\":5,\"broll_video_url\":\"PASTE_BROLL_URL_SCENE_1_HERE\"},{\"scene_number\":2,\"script_line\":\"Companies are saving millions\",\"duration_sec\":8,\"broll_video_url\":\"PASTE_BROLL_URL_SCENE_2_HERE\"},{\"scene_number\":3,\"script_line\":\"And honestly you are already missing out\",\"duration_sec\":7,\"broll_video_url\":\"PASTE_BROLL_URL_SCENE_3_HERE\"},{\"scene_number\":4,\"script_line\":\"Here is what you need to know right now\",\"duration_sec\":5,\"broll_video_url\":\"PASTE_BROLL_URL_SCENE_4_HERE\"}]",
              "type": "string"
            },
            {
              "id": "i5",
              "name": "pip_position",
              "value": "bottom-right",
              "type": "string"
            },
            {
              "id": "i6",
              "name": "pip_scale",
              "value": "0.35",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "a5d25041-fbc2-4dc6-9e6d-47b47ed5e379",
      "name": "ðŸ“ Set Video Inputs (Paste URLs Here)",
      "type": "n8n-nodes-base.set",
      "position": [
        992,
        1808
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "jsCode": "const item = $input.first().json;\nlet scenes = [];\n\ntry {\n  scenes = JSON.parse(item.scenes_json);\n} catch(e) {\n  throw new Error('scenes_json is not valid JSON. Please fix it in the Set Video Inputs node. Error: ' + e.message);\n}\n\n// Validate\nif (!scenes.length) throw new Error('scenes_json is empty array');\nif (!item.heygen_video_url || item.heygen_video_url === 'PASTE_HEYGEN_VIDEO_URL_HERE') {\n  throw new Error('heygen_video_url is not set. Paste the URL from HeyGen workflow output.');\n}\n\n// Check all b-roll URLs filled in\nscenes.forEach(s => {\n  if (!s.broll_video_url || s.broll_video_url.includes('PASTE_BROLL')) {\n    throw new Error(`Scene ${s.scene_number} b-roll URL is not filled in.`);\n  }\n});\n\n// Sort by scene number\nscenes.sort((a, b) => a.scene_number - b.scene_number);\n\nconsole.log('=== INPUT VALIDATION PASSED ===');\nconsole.log('Scenes:', scenes.length);\nconsole.log('HeyGen URL:', item.heygen_video_url);\nconsole.log('Total Duration:', item.total_duration_sec, 's');\n\nreturn [{\n  json: {\n    script_title: item.script_title,\n    heygen_video_url: item.heygen_video_url,\n    total_duration_sec: item.total_duration_sec,\n    pip_position: item.pip_position || 'bottom-right',\n    pip_scale: item.pip_scale || '0.35',\n    scenes: scenes\n  }\n}];"
      },
      "id": "15b6241a-4b4e-4982-9eef-d155d09ff536",
      "name": "ðŸ”§ Parse Scenes JSON",
      "type": "n8n-nodes-base.code",
      "position": [
        1216,
        1808
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "const item = $input.first().json;\nconst scenes = item.scenes;\nconst duration = item.total_duration_sec;\nconst heygenUrl = item.heygen_video_url;\nconst pipScale = item.pip_scale || '0.35';\n\n// Determine PiP position based on setting\nconst pipPositionMap = {\n  'bottom-right': 'W-w-20:H-h-20',\n  'bottom-left': '20:H-h-20',\n  'top-right': 'W-w-20:20',\n  'top-left': '20:20',\n  'bottom-center': '(W-w)/2:H-h-20'\n};\nconst pipPosition = pipPositionMap[item.pip_position] || 'W-w-20:H-h-20';\n\n// Build download commands per scene\nconst downloadBroll = scenes.map(s => {\n  return `echo \"Downloading Scene ${s.scene_number} B-Roll...\"\\ncurl -L \"${s.broll_video_url}\" -o broll_raw_${s.scene_number}.mp4 2>/dev/null || echo \"WARNING: Scene ${s.scene_number} download failed\"`;\n}).join('\\n');\n\n// Build trim commands per scene (trim 8s VEO3 clip to exact scene duration)\nconst trimBroll = scenes.map(s => {\n  const dur = Math.min(s.duration_sec, 8); // VEO3 max 8s\n  return `echo \"Trimming Scene ${s.scene_number} to ${dur}s...\"\\nffmpeg -y -i broll_raw_${s.scene_number}.mp4 -t ${dur} -c copy broll_trimmed_${s.scene_number}.mp4 2>/dev/null`;\n}).join('\\n');\n\n// Build filelist for concat\nconst fileList = scenes.map(s => `file 'broll_trimmed_${s.scene_number}.mp4'`).join('\\n');\n\n// Full FFmpeg script\nconst ffmpegScript = `#!/bin/bash\nset -e\n\n# ===================================\n# FFmpeg Video Assembly Script\n# Generated by n8n Submagic Workflow\n# ===================================\n\nmkdir -p /tmp/video_assembly\ncd /tmp/video_assembly\n\necho \"\\n=== STEP 1: Download HeyGen Talking Head ===\"\ncurl -L \"${heygenUrl}\" -o heygen_raw.mp4 2>/dev/null\necho \"HeyGen downloaded.\"\n\necho \"\\n=== STEP 2: Download B-Roll Clips ===\"\n${downloadBroll}\n\necho \"\\n=== STEP 3: Trim B-Roll to Scene Durations ===\"\n${trimBroll}\n\necho \"\\n=== STEP 4: Write Concat File List ===\"\ncat > filelist.txt << 'FILELIST'\n${fileList}\nFILELIST\necho \"filelist.txt created.\"\n\necho \"\\n=== STEP 5: Concatenate B-Roll Clips ===\"\nffmpeg -y -f concat -safe 0 -i filelist.txt -c copy broll_combined.mp4 2>/dev/null\necho \"B-roll concatenated.\"\n\necho \"\\n=== STEP 6: Remove Green Screen from HeyGen (Chroma Key) ===\"\nffmpeg -y -i heygen_raw.mp4 \\\n  -vf \"chromakey=0x00FF00:0.15:0.05,scale=iw*${pipScale}:-1\" \\\n  -c:v libx264 -preset fast -crf 20 \\\n  heygen_keyed.mp4 2>/dev/null\necho \"Chroma key applied.\"\n\necho \"\\n=== STEP 7: Add Ken Burns Zoom Effect to B-Roll ===\"\nffmpeg -y -i broll_combined.mp4 \\\n  -vf \"scale=1280:2276,zoompan=z='if(lte(on,1),1,if(lte(zoom,1.3),zoom+0.001,zoom))':d=1:x='iw/2-(iw/zoom/2)':y='ih/2-(ih/zoom/2)':s=1080x1920:fps=30\" \\\n  -c:v libx264 -preset fast -crf 23 \\\n  broll_zoomed.mp4 2>/dev/null\necho \"Zoom effect applied.\"\n\necho \"\\n=== STEP 8: Overlay HeyGen PiP on B-Roll ===\"\nffmpeg -y -i broll_zoomed.mp4 -i heygen_keyed.mp4 \\\n  -filter_complex \"[1:v][0:v]overlay=${pipPosition}:enable='between(t,0,${duration})'\" \\\n  -c:v libx264 -preset fast -crf 20 \\\n  combined_no_audio.mp4 2>/dev/null\necho \"PiP overlay applied.\"\n\necho \"\\n=== STEP 9: Merge HeyGen Audio with Combined Video ===\"\nffmpeg -y -i combined_no_audio.mp4 -i heygen_raw.mp4 \\\n  -map 0:v:0 -map 1:a:0 \\\n  -c:v copy -c:a aac -shortest \\\n  final_draft.mp4 2>/dev/null\necho \"Audio merged.\"\n\necho \"\\n=== PROCESSING COMPLETE ===\"\necho \"Output file: /tmp/video_assembly/final_draft.mp4\"\nls -lh final_draft.mp4\n`;\n\nreturn [{\n  json: {\n    ...item,\n    ffmpeg_script: ffmpegScript,\n    pip_position_ffmpeg: pipPosition,\n    output_file: '/tmp/video_assembly/final_draft.mp4'\n  }\n}];"
      },
      "id": "b014ec5c-04e9-49f2-9e53-dd9ced40f229",
      "name": "âš™ï¸ Build FFmpeg Processing Script",
      "type": "n8n-nodes-base.code",
      "position": [
        1456,
        1808
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "command": "={{ $json.ffmpeg_script }}"
      },
      "id": "6e7d2f90-2335-462c-b1d8-6ec311383c82",
      "name": "ðŸŽ¬ Execute FFmpeg Script",
      "type": "n8n-nodes-base.executeCommand",
      "position": [
        1696,
        1808
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "caseSensitive": false,
            "typeValidation": "strict"
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "ffmpeg-check",
              "operator": {
                "type": "string",
                "operation": "contains"
              },
              "leftValue": "={{ $json.stdout || '' }}",
              "rightValue": "PROCESSING COMPLETE"
            }
          ]
        },
        "options": {}
      },
      "id": "754edd12-dcab-43ca-b952-0ea3642f8154",
      "name": "âœ… FFmpeg Succeeded?",
      "type": "n8n-nodes-base.if",
      "position": [
        1920,
        1808
      ],
      "typeVersion": 2.2
    },
    {
      "parameters": {
        "jsCode": "const result = $input.first().json;\nconsole.error('=== FFMPEG FAILED ===');\nconsole.error('STDOUT:', result.stdout);\nconsole.error('STDERR:', result.stderr);\nconsole.error('Exit Code:', result.exitCode);\nreturn [{ json: { error: 'FFmpeg failed', stdout: result.stdout, stderr: result.stderr, exitCode: result.exitCode } }];"
      },
      "id": "429c503c-bf12-4ed5-b2ae-00b3d1b68145",
      "name": "âŒ Log FFmpeg Error",
      "type": "n8n-nodes-base.code",
      "position": [
        2144,
        1968
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "operation": "upload",
        "bucketName": "={{ $env.S3_BUCKET_NAME || 'your-bucket-name' }}",
        "additionalFields": {
          "acl": "public-read"
        }
      },
      "id": "68a218f8-2c7d-4e97-aea6-45c234b60d34",
      "name": "â˜ï¸ Upload final_draft.mp4 to S3/R2",
      "type": "n8n-nodes-base.s3",
      "position": [
        2144,
        1696
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "su1",
              "name": "final_video_url",
              "value": "={{ $json.url || 'https://' + $env.S3_BUCKET_NAME + '.r2.dev/videos/' + $('Build FFmpeg Processing Script').item.json.script_title.replace(/\\s+/g, '_') + '_' + Date.now() + '.mp4' }}",
              "type": "string"
            },
            {
              "id": "su2",
              "name": "script_title",
              "value": "={{ $('Build FFmpeg Processing Script').item.json.script_title }}",
              "type": "string"
            },
            {
              "id": "su3",
              "name": "total_duration_sec",
              "value": "={{ $('Build FFmpeg Processing Script').item.json.total_duration_sec }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "id": "25019aad-9b43-4f07-b9f8-20729b20b1a2",
      "name": "ðŸ”— Set Uploaded Video URL",
      "type": "n8n-nodes-base.set",
      "position": [
        2352,
        1696
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.submagic.co/v1/projects",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "x-api-key",
              "value": "={{ $env.SUBMAGIC_API_KEY }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  title: $json.script_title,\n  language: 'en',\n  videoUrl: $json.final_video_url,\n  templateName: 'Hormozi 2',\n  magicZooms: true,\n  magicBrolls: false,\n  captions: true,\n  captionStyle: 'modern',\n  effects: {\n    enableZoom: true,\n    enableCuts: true,\n    enableTransitions: true\n  }\n}) }}",
        "options": {}
      },
      "id": "9759e963-798b-4412-9a8d-87f546b7a0a5",
      "name": "âœ¨ Submit to Submagic",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        2576,
        1696
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "const response = $input.first().json;\nconst meta = $node['Set Uploaded Video URL'].json;\n\nconst projectId = response?.data?.id\n  || response?.project_id\n  || response?.id\n  || '';\n\nif (!projectId) {\n  throw new Error('Submagic project creation failed: ' + JSON.stringify(response));\n}\n\nconsole.log('Submagic Project Created:', projectId);\n\nreturn [{\n  json: {\n    ...meta,\n    submagic_project_id: projectId,\n    submagic_status: 'processing'\n  }\n}];"
      },
      "id": "105ec145-8c7c-4ab1-ae75-560148576e59",
      "name": "ðŸ“Œ Extract Submagic Project ID",
      "type": "n8n-nodes-base.code",
      "position": [
        2800,
        1696
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "unit": "minutes"
      },
      "id": "63409ff4-fdea-4eed-bf2f-beb472c76722",
      "name": "â³ Wait 5 Min (Submagic Processing)",
      "type": "n8n-nodes-base.wait",
      "position": [
        3024,
        1696
      ],
      "webhookId": "submagic-wait-01",
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "url": "=https://api.submagic.co/v1/projects/{{ $json.submagic_project_id }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "x-api-key",
              "value": "={{ $env.SUBMAGIC_API_KEY }}"
            }
          ]
        },
        "options": {}
      },
      "id": "4dc46c89-7f5e-4547-801b-7760f7d32f2b",
      "name": "ðŸ” Poll Submagic Status",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        3232,
        1696
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "const pollResult = $input.first().json;\nconst meta = $node['Extract Submagic Project ID'].json;\n\nconst status = (pollResult?.data?.status || pollResult?.status || 'processing').toLowerCase();\nconst videoUrl = pollResult?.data?.video_url || pollResult?.video_url || '';\n\nreturn [{\n  json: {\n    ...meta,\n    submagic_current_status: status,\n    submagic_video_url: videoUrl\n  }\n}];"
      },
      "id": "ec32d5ee-e31e-4598-876b-d4e1c7ec889a",
      "name": "ðŸ” Re-attach Metadata",
      "type": "n8n-nodes-base.code",
      "position": [
        3232,
        1888
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "caseSensitive": false,
            "typeValidation": "strict"
          },
          "combinator": "or",
          "conditions": [
            {
              "id": "submagic-check-done",
              "operator": {
                "name": "filter.operator.equals",
                "type": "string",
                "operation": "equals"
              },
              "leftValue": "={{ $json.submagic_current_status }}",
              "rightValue": "completed"
            },
            {
              "id": "submagic-check-ready",
              "operator": {
                "name": "filter.operator.equals",
                "type": "string",
                "operation": "equals"
              },
              "leftValue": "={{ $json.submagic_current_status }}",
              "rightValue": "ready"
            }
          ]
        },
        "options": {}
      },
      "id": "7373d7b7-5048-44c3-8beb-c50c377c566d",
      "name": "âœ… Submagic Complete?",
      "type": "n8n-nodes-base.if",
      "position": [
        3456,
        1696
      ],
      "typeVersion": 2.2
    },
    {
      "parameters": {
        "amount": 3,
        "unit": "minutes"
      },
      "id": "ccd35e05-5213-4eea-98dd-b50b76d36fa5",
      "name": "â° Wait 3 Min (Submagic Retry)",
      "type": "n8n-nodes-base.wait",
      "position": [
        3680,
        1856
      ],
      "webhookId": "submagic-retry-01",
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "fo1",
              "name": "script_title",
              "value": "={{ $json.script_title }}",
              "type": "string"
            },
            {
              "id": "fo2",
              "name": "submagic_project_id",
              "value": "={{ $json.submagic_project_id }}",
              "type": "string"
            },
            {
              "id": "fo3",
              "name": "final_video_url",
              "value": "={{ $json.submagic_video_url }}",
              "type": "string"
            },
            {
              "id": "fo4",
              "name": "status",
              "value": "COMPLETE",
              "type": "string"
            },
            {
              "id": "fo5",
              "name": "total_duration_sec",
              "value": "={{ $json.total_duration_sec }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "id": "7194fc70-9298-4c85-ba61-eed555d38d3b",
      "name": "ðŸŽ‰ FINAL â€” Save Output",
      "type": "n8n-nodes-base.set",
      "position": [
        3680,
        1568
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "jsCode": "const item = $input.first().json;\nconsole.log('=== VIDEO PRODUCTION COMPLETE ===');\nconsole.log('Title:', item.script_title);\nconsole.log('Duration:', item.total_duration_sec, 'seconds');\nconsole.log('Submagic Project ID:', item.submagic_project_id);\nconsole.log('Final Video URL:', item.final_video_url);\nconsole.log('');\nconsole.log('>>> DOWNLOAD YOUR VIDEO FROM ABOVE URL <<<');\nreturn [{ json: item }];"
      },
      "id": "d474499e-ec2c-44c3-8e8c-dd9c9269664f",
      "name": "ðŸ“‹ Log Final Result",
      "type": "n8n-nodes-base.code",
      "position": [
        3904,
        1568
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "content": "## âš™ï¸ HOW TO USE THIS WORKFLOW\n\n**Step 1:** Run Workflow 1 (HeyGen) â†’ Copy `heygen_video_url`\n\n**Step 2:** Run Workflow 2 (VEO3) â†’ Copy all `broll_video_url` values per scene\n\n**Step 3:** Paste into **Set Video Inputs** node:\n- `heygen_video_url` â†’ paste URL from Step 1\n- `scenes_json` â†’ update each scene's `broll_video_url` with URLs from Step 2\n- `total_duration_sec` â†’ total video length in seconds\n- `pip_position` â†’ where to place talking head\n\n**Step 4:** Run this workflow â†’ Get final edited video URL",
        "height": 280,
        "width": 720,
        "color": 3
      },
      "id": "b9b2c5db-e1a3-4e32-b7a8-882accb6cd31",
      "name": "Sticky â€” How to Use",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        752,
        2000
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## âœ‚ï¸ STANDALONE 3 â€” FFmpeg + Submagic Assembly\n\n### What This Does:\n1. Takes HeyGen video URL (from Workflow 1)\n2. Takes all VEO3 b-roll URLs + scene durations (from Workflow 2)\n3. Downloads all videos\n4. Trims each b-roll to exact scene duration\n5. Concatenates all b-roll clips\n6. Removes green screen from HeyGen (chroma key)\n7. Adds Ken Burns zoom effect to b-roll\n8. Overlays HeyGen as PiP (bottom-right corner, 35% size)\n9. Merges HeyGen audio onto combined video\n10. Uploads to S3/R2\n11. Submits to Submagic (captions + Hormozi effects + transitions)\n12. Polls until Submagic complete\n13. Returns final download URL\n\n### ENV VARS Required:\n- `SUBMAGIC_API_KEY`\n- `S3_BUCKET_NAME`\n- S3 / R2 credential in n8n\n\n### PiP Position Options (set in config):\n- `bottom-right` (default, most common)\n- `bottom-left`\n- `top-right`\n- `top-left`\n- `bottom-center`",
        "height": 440,
        "width": 720,
        "color": 2
      },
      "id": "adcd51e2-e8d1-44f3-ad20-dbfce7af21d1",
      "name": "Sticky â€” Overview2",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        752,
        1536
      ],
      "typeVersion": 1
    }
  ],
  "pinData": {},
  "connections": {
    "Get Analyzed Content": {
      "main": [
        [
          {
            "node": "Filter: Status = Generate Script",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter: Status = Generate Script": {
      "main": [
        [
          {
            "node": "Generate Video Script",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gemini 2.0 Script": {
      "ai_languageModel": [
        [
          {
            "node": "Generate Video Script",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Generate Video Script": {
      "main": [
        [
          {
            "node": "Parse AI Script",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse AI Script": {
      "main": [
        [
          {
            "node": "Store Script in Library",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Trigger Generate Script": {
      "main": [
        [
          {
            "node": "Get Analyzed Content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Schedule Trigger (Every 12h)": {
      "main": [
        [
          {
            "node": "Generate Global URLs",
            "type": "main",
            "index": 0
          },
          {
            "node": "Generate Reddit URLs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Global URLs": {
      "main": [
        [
          {
            "node": "Fetch Google Trends RSS",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Google Trends RSS": {
      "main": [
        [
          {
            "node": "Parse All Trends (Full Metadata)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse All Trends (Full Metadata)": {
      "main": [
        [
          {
            "node": "Filter Viral Trends (500+)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter Viral Trends (500+)": {
      "main": [
        [
          {
            "node": "Merge: Google Trends + Reddit",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Reddit URLs": {
      "main": [
        [
          {
            "node": "Fetch Reddit Posts",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Reddit Posts": {
      "main": [
        [
          {
            "node": "Parse Reddit Posts",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Reddit Posts": {
      "main": [
        [
          {
            "node": "Merge: Google Trends + Reddit",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge: Google Trends + Reddit": {
      "main": [
        [
          {
            "node": "Gemini: Viral Scout",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gemini 2.0 (Scout)": {
      "ai_languageModel": [
        [
          {
            "node": "Gemini: Viral Scout",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Gemini: Viral Scout": {
      "main": [
        [
          {
            "node": "Top Viral Bangers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Top Viral Bangers": {
      "main": [
        [
          {
            "node": "Store in Inspiration DB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Store in Inspiration DB": {
      "main": [
        []
      ]
    },
    "Trigger Scraping Run": {
      "main": [
        [
          {
            "node": "Read Inspiration DB (Pending)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Read Inspiration DB (Pending)": {
      "main": [
        [
          {
            "node": "Gemini: Hashtag Optimizer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gemini: Hashtag Optimizer": {
      "main": [
        [
          {
            "node": "Parse Keywords",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gemini 2.0 (Optimizer)": {
      "ai_languageModel": [
        [
          {
            "node": "Gemini: Hashtag Optimizer",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Parse Keywords": {
      "main": [
        [
          {
            "node": "Apify: Scrape Instagram Reels",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Apify: Scrape Instagram Reels": {
      "main": [
        [
          {
            "node": "Normalize Reel Metadata",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalize Reel Metadata": {
      "main": [
        [
          {
            "node": "Fetch Subtitles (SRT)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Subtitles (SRT)": {
      "main": [
        [
          {
            "node": "Clean Subtitles",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Clean Subtitles": {
      "main": [
        [
          {
            "node": "Analyze Viral Content (Gemini)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze Viral Content (Gemini)": {
      "main": [
        [
          {
            "node": "Parse Gemini Analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gemini 2.0 Flash": {
      "ai_languageModel": [
        [
          {
            "node": "Analyze Viral Content (Gemini)",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Parse Gemini Analysis": {
      "main": [
        [
          {
            "node": "Store in Viral Content DB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Manual Discovery Trigger": {
      "main": [
        [
          {
            "node": "Generate Global URLs",
            "type": "main",
            "index": 0
          },
          {
            "node": "Generate Reddit URLs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“ Set Script + Config": {
      "main": [
        [
          {
            "node": "ðŸ”§ Prepare ElevenLabs Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ”§ Prepare ElevenLabs Request": {
      "main": [
        [
          {
            "node": "ðŸŽ™ï¸ Generate Voice (ElevenLabs)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸŽ™ï¸ Generate Voice (ElevenLabs)": {
      "main": [
        [
          {
            "node": "ðŸ“Ž Attach Audio + Carry Metadata",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“Ž Attach Audio + Carry Metadata": {
      "main": [
        [
          {
            "node": "â˜ï¸ Upload Audio to HeyGen",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "â˜ï¸ Upload Audio to HeyGen": {
      "main": [
        [
          {
            "node": "ðŸ”— Extract Audio Asset ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ”— Extract Audio Asset ID": {
      "main": [
        [
          {
            "node": "ðŸ—ï¸ Build HeyGen Video Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ—ï¸ Build HeyGen Video Request": {
      "main": [
        [
          {
            "node": "ðŸŽ¬ Submit HeyGen Video Generation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸŽ¬ Submit HeyGen Video Generation": {
      "main": [
        [
          {
            "node": "ðŸ“Œ Extract HeyGen Video ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“Œ Extract HeyGen Video ID": {
      "main": [
        [
          {
            "node": "â³ Wait 10 Min (HeyGen Processing)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "â³ Wait 10 Min (HeyGen Processing)": {
      "main": [
        [
          {
            "node": "ðŸ” Poll HeyGen Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ” Poll HeyGen Status": {
      "main": [
        [
          {
            "node": "ðŸ” Re-attach Metadata for Poll",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ” Re-attach Metadata for Poll": {
      "main": [
        [
          {
            "node": "âœ… HeyGen Complete?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âœ… HeyGen Complete?": {
      "main": [
        [
          {
            "node": "ðŸ’¾ Save HeyGen Video URL",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "â° Wait 5 Min (Retry)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "â° Wait 5 Min (Retry)": {
      "main": [
        [
          {
            "node": "ðŸ” Poll HeyGen Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ’¾ Save HeyGen Video URL": {
      "main": [
        [
          {
            "node": "âœ… DONE â€” Log Output",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ§  Claude Sonnet": {
      "ai_languageModel": [
        [
          {
            "node": "ðŸ¤– Claude â€” Split Script into Scenes",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“‹ Scene Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "ðŸ¤– Claude â€” Split Script into Scenes",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ¤– Claude â€” Split Script into Scenes": {
      "main": [
        [
          {
            "node": "ðŸ“¦ Store Parsed Scenes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“¦ Store Parsed Scenes": {
      "main": [
        [
          {
            "node": "ðŸ”€ Split Scenes (One Per Item)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ”€ Split Scenes (One Per Item)": {
      "main": [
        [
          {
            "node": "ðŸŽžï¸ Set Current Scene Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸŽžï¸ Set Current Scene Data": {
      "main": [
        [
          {
            "node": "ðŸŽ¥ VEO3 â€” Submit B-Roll Job",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸŽ¥ VEO3 â€” Submit B-Roll Job": {
      "main": [
        [
          {
            "node": "ðŸ“Œ Save VEO3 Request ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“Œ Save VEO3 Request ID": {
      "main": [
        [
          {
            "node": "â³ Wait 5 Min (VEO3 Processing)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "â³ Wait 5 Min (VEO3 Processing)": {
      "main": [
        [
          {
            "node": "ðŸ” Poll VEO3 Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ” Poll VEO3 Status": {
      "main": [
        [
          {
            "node": "ðŸ” Re-attach Scene Metadata",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ” Re-attach Scene Metadata": {
      "main": [
        [
          {
            "node": "âœ… VEO3 Complete?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âœ… VEO3 Complete?": {
      "main": [
        [
          {
            "node": "ðŸ“¥ Fetch VEO3 Video Result",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "â° Wait 3 Min (VEO3 Retry)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "â° Wait 3 Min (VEO3 Retry)": {
      "main": [
        [
          {
            "node": "ðŸ” Poll VEO3 Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“¥ Fetch VEO3 Video Result": {
      "main": [
        [
          {
            "node": "ðŸ’¾ Extract + Save B-Roll URL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ’¾ Extract + Save B-Roll URL": {
      "main": [
        [
          {
            "node": "ðŸ§© Aggregate All B-Roll Clips",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ§© Aggregate All B-Roll Clips": {
      "main": [
        [
          {
            "node": "ðŸ“Š Build Final Summary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“ Set Script + Config1": {
      "main": [
        [
          {
            "node": "ðŸ¤– Claude â€” Split Script into Scenes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“ Set Video Inputs (Paste URLs Here)": {
      "main": [
        [
          {
            "node": "ðŸ”§ Parse Scenes JSON",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ”§ Parse Scenes JSON": {
      "main": [
        [
          {
            "node": "âš™ï¸ Build FFmpeg Processing Script",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âš™ï¸ Build FFmpeg Processing Script": {
      "main": [
        [
          {
            "node": "ðŸŽ¬ Execute FFmpeg Script",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸŽ¬ Execute FFmpeg Script": {
      "main": [
        [
          {
            "node": "âœ… FFmpeg Succeeded?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âœ… FFmpeg Succeeded?": {
      "main": [
        [
          {
            "node": "â˜ï¸ Upload final_draft.mp4 to S3/R2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "âŒ Log FFmpeg Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "â˜ï¸ Upload final_draft.mp4 to S3/R2": {
      "main": [
        [
          {
            "node": "ðŸ”— Set Uploaded Video URL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ”— Set Uploaded Video URL": {
      "main": [
        [
          {
            "node": "âœ¨ Submit to Submagic",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âœ¨ Submit to Submagic": {
      "main": [
        [
          {
            "node": "ðŸ“Œ Extract Submagic Project ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“Œ Extract Submagic Project ID": {
      "main": [
        [
          {
            "node": "â³ Wait 5 Min (Submagic Processing)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "â³ Wait 5 Min (Submagic Processing)": {
      "main": [
        [
          {
            "node": "ðŸ” Poll Submagic Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ” Poll Submagic Status": {
      "main": [
        [
          {
            "node": "ðŸ” Re-attach Metadata",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ” Re-attach Metadata": {
      "main": [
        [
          {
            "node": "âœ… Submagic Complete?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âœ… Submagic Complete?": {
      "main": [
        [
          {
            "node": "ðŸŽ‰ FINAL â€” Save Output",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "â° Wait 3 Min (Submagic Retry)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "â° Wait 3 Min (Submagic Retry)": {
      "main": [
        [
          {
            "node": "ðŸ” Poll Submagic Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸŽ‰ FINAL â€” Save Output": {
      "main": [
        [
          {
            "node": "ðŸ“‹ Log Final Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false
  },
  "versionId": "721eed57-e18b-40a7-be52-a9462467cdec",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "dc87f94e8f44b5018e54a588eebeaae61eebdb6c256f8f2f61b7c6ba347bca63"
  },
  "id": "0ZSLiDZcYmBRLfgI",
  "tags": []
}