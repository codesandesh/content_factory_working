services:
  n8n:
    image: n8nio/n8n:latest
    container_name: n8n_content_factory
    user: root
    restart: always
    ports:
      - "5678:5678"
    env_file:
      - .env
    environment:
      # n8n Core
      - N8N_PROTOCOL=${N8N_PROTOCOL}
      - N8N_HOST=${N8N_HOST}
      - N8N_PORT=${N8N_PORT}
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
      - N8N_LOG_LEVEL=${N8N_LOG_LEVEL:-info}
      - N8N_LOG_OUTPUT=console
      - N8N_DIAGNOSTICS_ENABLED=false
      - N8N_BLOCK_ENV_ACCESS_IN_EXPRESSIONS=false
      - N8N_BLOCK_ENV_ACCESS_IN_NODE=false
      - N8N_ALLOW_EXECUTE_COMMAND=true
      - NODES_EXCLUDE=[]

      # Auto-restore credentials on every startup (survives docker compose down/up)
      - N8N_CREDENTIALS_OVERWRITE_DATA={"airtableTokenApi":{"accessToken":"${AIRTABLE_PAT}"},"googlePalmApi":{"apiKey":"${GOOGLE_API_KEY}"},"linkedInOAuth2Api":{"clientId":"${LINKEDIN_CLIENT_ID}","clientSecret":"${LINKEDIN_CLIENT_SECRET}"}}

      # Execution
      - EXECUTIONS_MODE=queue
      - EXECUTIONS_DATA_SAVE_ON_ERROR=all
      - EXECUTIONS_DATA_SAVE_ON_SUCCESS=all
      - EXECUTIONS_DATA_SAVE_MANUAL_EXECUTIONS=true
      - EXECUTIONS_DATA_PRUNE=true
      - EXECUTIONS_DATA_MAX_AGE=336

      # Database (Postgres)
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=n8n
      - DB_POSTGRESDB_USER=n8n
      - DB_POSTGRESDB_PASSWORD=${POSTGRES_PASSWORD}

      # Redis (Queue)
      - QUEUE_BULL_REDIS_HOST=${REDIS_HOST}
      - QUEUE_BULL_REDIS_PORT=${REDIS_PORT}
      - QUEUE_BULL_REDIS_PASSWORD=${REDIS_PASSWORD}

      # ── Stage 1: Reddit Scraper ──────────────────────────────
      - APIFY_API_TOKEN=${APIFY_API_TOKEN}

      # ── Stage 1 + 2: Gemini AI ──────────────────────────────
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - GEMINI_API_KEY=${GEMINI_API_KEY}

      # ── Stage 1 + 2 + 3: Airtable ──────────────────────────
      - AIRTABLE_BASE_ID=${AIRTABLE_BASE_ID}
      - AT_VIRAL_CONTENT_TABLE=${AT_VIRAL_CONTENT_TABLE}
      - AT_TABLE_VIRAL_DB=${AT_TABLE_VIRAL_DB}
      - AT_SCRIPT_LIBRARY_TABLE=${AT_SCRIPT_LIBRARY_TABLE}
      - AT_TABLE_SCRIPT_LIB=${AT_TABLE_SCRIPT_LIB}

      # ── Stage 3: Facebook ───────────────────────────────────
      - FACEBOOK_PAGE_ID=${FACEBOOK_PAGE_ID}
      - FACEBOOK_PAGE_ACCESS_TOKEN=${FACEBOOK_PAGE_ACCESS_TOKEN}

      # ── Stage 3: LinkedIn ───────────────────────────────────
      - LINKEDIN_CLIENT_ID=${LINKEDIN_CLIENT_ID}
      - LINKEDIN_CLIENT_SECRET=${LINKEDIN_CLIENT_SECRET}

    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./n8n:/home/node/.n8n
      - ./logs:/home/node/.n8n/logs
    networks:
      - n8n-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:5678/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  postgres:
    image: postgres:15-alpine
    container_name: n8n_postgres
    restart: always
    environment:
      - POSTGRES_USER=n8n
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=n8n
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - ./postgres-data:/var/lib/postgresql/data
    networks:
      - n8n-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U n8n"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  redis:
    image: redis:7-alpine
    container_name: n8n_redis
    restart: always
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD}
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --save 60 1000
      --appendonly yes
    volumes:
      - ./redis-data:/data
    networks:
      - n8n-network
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  n8n-network:
    driver: bridge
